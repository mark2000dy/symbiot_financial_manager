<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Gastos - Sistema de Gastos Symbiot</title>
    
    <!-- PWA Configuration -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#191C24">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body {
            background: linear-gradient(135deg, #000 0%, #191C24 50%, #000 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: white;
        }

        /* FIX PARA DROPDOWN MENU Z-INDEX */
        .navbar .dropdown-menu {
            z-index: 9999 !important;
            position: absolute !important;
        }

        .dropdown-menu.show {
            z-index: 9999 !important;
        }

        .welcome-banner {
            z-index: 1 !important;
        }

        /* Fix para dropdown menu z-index */
        .navbar {
            z-index: 1030;
        }

        .dropdown-menu {
            z-index: 1040 !important;
        }

        .welcome-banner {
            z-index: 1000;
        }
        
        .navbar {
            background: rgba(25, 28, 36, 0.95) !important;
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .navbar-brand {
            color: #EB1616 !important;
            font-weight: bold;
            font-size: 1.5rem;
        }
        
        .navbar-nav .nav-link {
            color: rgba(255, 255, 255, 0.8) !important;
            transition: color 0.3s ease;
        }
        
        .navbar-nav .nav-link:hover,
        .navbar-nav .nav-link.active {
            color: #EB1616 !important;
        }
        
        .main-content {
            padding: 2rem 0;
        }
        
        .card {
            background: rgba(25, 28, 36, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
        }
        
        .card-header {
            background: rgba(220, 53, 69, 0.1);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .form-control, .form-select {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
        }
        
        .form-control:focus, .form-select:focus {
            background: rgba(255, 255, 255, 0.15);
            border-color: #DC3545;
            box-shadow: 0 0 0 0.25rem rgba(220, 53, 69, 0.25);
            color: white;
        }
        
        .form-control::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }
        
        .form-select option {
            background: #191C24;
            color: white;
        }
        
        .btn-primary {
            background-color: #DC3545;
            border-color: #DC3545;
        }

        .btn-primary:hover {
            background-color: #C82333;
            border-color: #C82333;
        }
        
        .btn-outline-secondary {
            border-color: rgba(255, 255, 255, 0.3);
            color: rgba(255, 255, 255, 0.8);
        }
        
        .btn-outline-secondary:hover {
            background-color: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.5);
            color: white;
        }
        
        .table-dark {
            --bs-table-bg: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .table-dark th, .table-dark td {
            border-color: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        .badge {
            font-size: 0.8em;
        }
        
        .badge.bg-success {
            background-color: #DC3545 !important;
        }

        .alert-info {
            background-color: rgba(220, 53, 69, 0.15) !important;
            border-color: rgba(220, 53, 69, 0.4) !important;
            color: #FFFFFF !important;
        }
        
        .alert-info strong {
            color: #FFFFFF !important;
        }
        
        /* Mejorar visibilidad de textos */
        .text-muted, .small {
            color: #E4E6EA !important;
        }
        
        .card-body small {
            color: #E4E6EA !important;
        }
        
        /* Estilos espec√≠ficos para gr√°fica */
        #chartLoading {
            color: #FFFFFF !important;
        }
        
        #chartLoading p {
            color: #E4E6EA !important;
        }
        
        .chart-summary h6 {
            font-weight: bold;
        }
        
        .chart-summary small {
            color: #E4E6EA !important;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* Paginaci√≥n */
        .page-link {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.2);
            color: #E4E6EA;
        }
        
        .page-link:hover {
            background: rgba(220, 53, 69, 0.2);
            border-color: #DC3545;
            color: white;
        }

        .page-item.active .page-link {
            background-color: #DC3545;
            border-color: #DC3545;
            color: white;
        }
        
        .page-item.disabled .page-link {
            color: rgba(255, 255, 255, 0.3);
            background-color: rgba(255, 255, 255, 0.05);
        }
        
        /* Loading spinner */
        .loading-spinner {
            text-align: center;
            padding: 50px 0;
            color: #E4E6EA;
        }
        
        /* Modal */
        .modal-content {
            background: rgba(25, 28, 36, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }
        
        .modal-header {
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .modal-footer {
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .btn-close {
            filter: invert(1);
        }
        
        /* Estad√≠sticas en gr√°fica */
        .stat-card-small {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.75rem;
            transition: all 0.3s ease;
        }
        
        .stat-card-small:hover {
            background: rgba(255, 255, 255, 0.12);
            transform: translateY(-2px);
        }
        
        .stat-icon-small {
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            border-radius: 0.5rem;
        }
        
        .stat-icon-small i {
            font-size: 1.2rem;
        }
        
        .stat-card-small h5 {
            font-size: 1.1rem;
            line-height: 1.2;
            font-weight: 600;
            color: #FFFFFF !important;
        }
        
        /* Dropdown menus */
        .dropdown-menu {
            background: rgba(25, 28, 36, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }
        
        .dropdown-item {
            color: #E4E6EA;
        }
        
        .dropdown-item:hover {
            background: rgba(82, 196, 26, 0.2);
            color: white;
        }
        
        /* Form labels */
        .form-label {
            color: #E4E6EA !important;
            font-weight: 500;
        }
        
        /* Welcome banner */
        .welcome-banner {
            background: linear-gradient(135deg, rgba(220, 53, 69, 0.15), rgba(248, 215, 218, 0.1));
            border: 1px solid rgba(220, 53, 69, 0.3);
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .welcome-banner h4 {
            color: #DC3545;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        .welcome-banner p {
            color: #E4E6EA;
            margin-bottom: 0;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/gastos">
                <img src="assets/images/Symbiot_logo_dark_horizon.png" alt="SYMBIOT Logo" style="height: 30px; margin-right: 8px;">
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="dashboard.html">
                            <i class="fas fa-tachometer-alt me-1"></i>Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="gastos.html">
                            <i class="fas fa-money-bill-wave me-1"></i>Gastos
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="ingresos.html">
                            <i class="fas fa-coins me-1"></i>Ingresos
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="event.preventDefault(); showComingSoon('Reportes');">
                            <i class="fas fa-chart-bar me-1"></i>Reportes
                        </a>
                    </li>
                </ul>
                
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user-circle me-1"></i>
                            <span id="userName">Usuario</span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="#" onclick="event.preventDefault(); showComingSoon('Perfil');"><i class="fas fa-user me-2"></i>Perfil</a></li>
                            <li><a class="dropdown-item" href="#" onclick="event.preventDefault(); showComingSoon('Configuraci√≥n');"><i class="fas fa-cog me-2"></i>Configuraci√≥n</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="event.preventDefault(); logout();"><i class="fas fa-sign-out-alt me-2"></i>Cerrar Sesi√≥n</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid main-content">
        <!-- Welcome Banner -->
        <div class="welcome-banner" id="welcomeBanner">
             <h4 class="mb-1"><i class="fas fa-money-bill-wave me-2"></i>An√°lisis de Gastos</h4>
                <p class="mb-0">¬°Bienvenido, <span id="userNameDisplay">Usuario</span>! ‚Ä¢
                    <i class="fas fa-building me-1"></i>
                    <span id="userCompany">Cargando...</span> ‚Ä¢ 
                    <span id="currentDate"></span>
                </p>
        </div>

        <!-- Widget Gr√°fica de Gastos Interactivo -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="text-white mb-0">
                    <i class="fas fa-chart-line me-2"></i>An√°lisis de Gastos por Per√≠odo
                </h5>
                <div class="btn-group btn-group-sm" role="group">
                    <button type="button" class="btn btn-outline-light" id="chartViewYear" onclick="setChartView('year')">üìÖ Anual</button>
                    <button type="button" class="btn btn-outline-light active" id="chartViewMonth" onclick="setChartView('month')">üìÜ Mensual</button>
                </div>
            </div>
            <div class="card-body">
                <!-- Loading de gr√°fica -->
                <div class="text-center py-4" id="chartLoading">
                    <i class="fas fa-spinner fa-spin fa-2x text-success"></i>
                    <p class="mt-2 text-white">Cargando datos de gr√°fica...</p>
                </div>
                
                <!-- Canvas para Chart.js -->
                <div id="chartContainer" style="display: none; position: relative; height: 400px;">
                    <canvas id="gastosChart"></canvas>
                </div>
                
                <!-- Error state -->
                <div class="text-center py-4" id="chartError" style="display: none;">
                    <i class="fas fa-exclamation-triangle fa-2x text-warning"></i>
                    <p class="mt-2 text-white">Error cargando gr√°fica</p>
                    <button class="btn btn-outline-primary btn-sm" onclick="loadGastosChart()">üîÑ Reintentar</button>
                </div>
                
                <!-- Estad√≠sticas del An√°lisis -->
                <div id="chartSummary" style="display: none;">
                    <hr class="my-4" style="border-color: rgba(255, 255, 255, 0.2);">
                    <div class="row g-3">
                        <!-- Total Gastos Card -->
                        <div class="col-sm-6 col-lg-3">
                            <div class="card stat-card-small h-100">
                                <div class="card-body d-flex align-items-center p-3">
                                    <div class="stat-icon-small bg-success bg-opacity-20 rounded-circle me-3">
                                        <i class="fas fa-coins text-success"></i>
                                    </div>
                                    <div>
                                        <h5 class="mb-0 text-success" id="totalGastosChart">$0</h5>
                                        <small style="color: #E4E6EA !important;">üí∏ Total Gastos</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Promedio Card -->
                        <div class="col-sm-6 col-lg-3">
                            <div class="card stat-card-small h-100">
                                <div class="card-body d-flex align-items-center p-3">
                                    <div class="stat-icon-small bg-info bg-opacity-20 rounded-circle me-3">
                                        <i class="fas fa-chart-bar text-info"></i>
                                    </div>
                                    <div>
                                        <h5 class="mb-0 text-info" id="promedioGastosChart">$0</h5>
                                        <small style="color: #E4E6EA !important;">üìä Promedio</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Mayor Gasto Card -->
                        <div class="col-sm-6 col-lg-3">
                            <div class="card stat-card-small h-100">
                                <div class="card-body d-flex align-items-center p-3">
                                    <div class="stat-icon-small bg-warning bg-opacity-20 rounded-circle me-3">
                                        <i class="fas fa-trophy text-warning"></i>
                                    </div>
                                    <div>
                                        <h5 class="mb-0 text-warning" id="mayorGastoChart">$0</h5>
                                        <small style="color: #E4E6EA !important;">üèÜ Mayor Gasto</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Transacciones Card -->
                        <div class="col-sm-6 col-lg-3">
                            <div class="card stat-card-small h-100">
                                <div class="card-body d-flex align-items-center p-3">
                                    <div class="stat-icon-small bg-primary bg-opacity-20 rounded-circle me-3">
                                        <i class="fas fa-list text-primary"></i>
                                    </div>
                                    <div>
                                        <h5 class="mb-0 text-primary" id="totalTransaccionesChart">0</h5>
                                        <small style="color: #E4E6EA !important;">üìù Transacciones</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Widget de Filtros -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="text-white mb-0">
                    <i class="fas fa-filter me-2"></i>üîç Filtros de B√∫squeda
                </h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <!-- Filtro de Empresa -->
                    <div class="col-md-3">
                        <label for="filterEmpresa" class="form-label">
                            <i class="fas fa-building me-1"></i>Empresa
                        </label>
                        <select class="form-select" id="filterEmpresa" onchange="applyFilters()">
                            <option value="">Todas las empresas</option>
                            <option value="1">üé∏ Rockstar Skull</option>
                            <option value="2">ü§ñ Symbiot Technologies</option>
                        </select>
                    </div>
                    
                    <!-- Filtro de A√±o -->
                    <div class="col-md-2">
                        <label for="filterAno" class="form-label">
                            <i class="fas fa-calendar me-1"></i>A√±o
                        </label>
                        <select class="form-select" id="filterAno" onchange="applyFilters()">
                            <option value="">Todos</option>
                            <option value="2025">2025</option>
                            <option value="2024">2024</option>
                            <option value="2023">2023</option>
                        </select>
                    </div>
                    
                    <!-- Filtro de Mes -->
                    <div class="col-md-2">
                        <label for="filterMes" class="form-label">
                            <i class="fas fa-calendar-alt me-1"></i>Mes
                        </label>
                        <select class="form-select" id="filterMes" onchange="applyFilters()">
                            <option value="">Todos</option>
                            <option value="1">Enero</option>
                            <option value="2">Febrero</option>
                            <option value="3">Marzo</option>
                            <option value="4">Abril</option>
                            <option value="5">Mayo</option>
                            <option value="6">Junio</option>
                            <option value="7">Julio</option>
                            <option value="8">Agosto</option>
                            <option value="9">Septiembre</option>
                            <option value="10">Octubre</option>
                            <option value="11">Noviembre</option>
                            <option value="12">Diciembre</option>
                        </select>
                    </div>
                    
                    <!-- Filtro de Tipo -->
                    <div class="col-md-2">
                        <label for="filterTipo" class="form-label">
                            <i class="fas fa-tag me-1"></i>Tipo
                        </label>
                        <select class="form-select" id="filterTipo" onchange="applyFilters()">
                            <option value="">Todos</option>
                            <option value="I" disabled>üí∞ Ingresos (Solo en secci√≥n Ingresos)</option>
                            <option value="G" selected>üí∏ Gastos </option>
                        </select>
                    </div>
                    
                    <!-- Botones de Acci√≥n -->
                    <div class="col-md-3">
                        <label class="form-label">&nbsp;</label>
                        <div class="d-flex gap-2">
                            <button class="btn btn-outline-secondary" onclick="clearFilters()">
                                <i class="fas fa-eraser me-1"></i>Limpiar
                            </button>
                            <button class="btn btn-primary" onclick="exportData()">
                                <i class="fas fa-download me-1"></i>Exportar
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Resumen de Filtros -->
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="alert alert-info d-flex justify-content-between align-items-center py-2 mb-0">
                            <div>
                                <strong>Filtros aplicados:</strong>
                                <span id="filterSummary">Mostrando üí∏ Gastos</span>
                            </div>
                            <div>
                                <span class="badge bg-success fs-6" id="totalRegistros">0</span> registros
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabla de Gastos -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="text-white mb-0">
                    <i class="fas fa-table me-2"></i>Lista de Transacciones
                </h5>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-secondary btn-sm" onclick="refreshTransactions()">
                        <i class="fas fa-sync-alt me-1"></i>Actualizar
                    </button>
                    <button class="btn btn-primary btn-sm" onclick="showAddModal()">
                        <i class="fas fa-plus me-1"></i>Nuevo Gasto
                    </button>
                </div>
            </div>
            <div class="card-body">
                <!-- Loading State -->
                <div class="loading-spinner" id="loadingSpinner">
                    <i class="fas fa-spinner fa-spin fa-2x text-success"></i>
                    <p class="mt-2">Cargando transacciones...</p>
                </div>

                <!-- Tabla -->
                <div class="table-responsive" id="tableContainer" style="display: none;">
                    <table class="table table-dark table-hover">
                        <thead>
                            <tr>
                                <th><i class="fas fa-calendar-alt me-1"></i>Fecha</th>
                                <th><i class="fas fa-receipt me-1"></i>Concepto</th>
                                <th><i class="fas fa-user me-1"></i>Socio</th>
                                <th><i class="fas fa-building me-1"></i>Empresa</th>
                                <th><i class="fas fa-credit-card me-1"></i>Forma de Pago</th>
                                <th><i class="fas fa-tag me-1"></i>Tipo</th>
                                <th class="text-end"><i class="fas fa-dollar-sign me-1"></i>Total</th>
                                <th class="text-center"><i class="fas fa-cogs me-1"></i>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <!-- Se llenar√° din√°micamente -->
                        </tbody>
                    </table>
                </div>

                <!-- Paginaci√≥n -->
                <nav aria-label="Paginaci√≥n de gastos" class="mt-3" id="paginationNav" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <small class="text-white">
                                Mostrando <span id="showingFrom">1</span> - <span id="showingTo">30</span> 
                                de <span id="totalRecords">0</span> registros
                            </small>
                        </div>
                        <ul class="pagination pagination-sm mb-0">
                            <li class="page-item" id="prevPage">
                                <a class="page-link" href="#" onclick="changePage('prev')">
                                    <i class="fas fa-chevron-left"></i> Anterior
                                </a>
                            </li>
                            <li class="page-item active">
                                <span class="page-link" id="currentPageSpan">1</span>
                            </li>
                            <li class="page-item" id="nextPage">
                                <a class="page-link" href="#" onclick="changePage('next')">
                                    Siguiente <i class="fas fa-chevron-right"></i>
                                </a>
                            </li>
                        </ul>
                    </div>
                </nav>

                <!-- Empty State -->
                <div class="text-center py-5" id="emptyState" style="display: none;">
                    <i class="fas fa-search fa-3x" style="color: rgba(255, 255, 255, 0.3);"></i>
                    <h5 class="mt-3" style="color: #E4E6EA;">No se encontraron transacciones</h5>
                    <p style="color: #E4E6EA;">Intenta ajustar los filtros o agregar nuevas transacciones.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Nueva Transacci√≥n -->
    <div class="modal fade" id="transactionModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title text-white">
                        <i class="fas fa-plus me-2"></i>
                        <span id="modalTitle">Nueva Transacci√≥n</span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="transactionForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="transactionDate" class="form-label">
                                    <i class="fas fa-calendar-alt me-1"></i>Fecha
                                </label>
                                <input type="date" class="form-control" id="transactionDate" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="transactionType" class="form-label">
                                    <i class="fas fa-tag me-1"></i>Tipo
                                </label>
                                <select class="form-select" id="transactionType" required>
                                    <option value="I" disabled>üí∞ Ingresos (Solo en secci√≥n Ingresos)</option>
                                    <option value="G" selected>üí∏ Gasto </option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="transactionCompany" class="form-label">
                                    <i class="fas fa-building me-1"></i>Empresa
                                </label>
                                <select class="form-select" id="transactionCompany" required>
                                    <option value="">Seleccionar empresa</option>
                                    <option value="1">üé∏ Rockstar Skull</option>
                                    <option value="2">ü§ñ Symbiot Technologies</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="transactionPartner" class="form-label">
                                    <i class="fas fa-user me-1"></i>Socio/Cliente
                                </label>
                                <input type="text" class="form-control" id="transactionPartner" placeholder="Nombre del socio o cliente" required>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="transactionConcept" class="form-label">
                                <i class="fas fa-receipt me-1"></i>Concepto/Descripci√≥n
                            </label>
                            <textarea class="form-control" id="transactionConcept" rows="2" placeholder="Descripci√≥n del gasto" required></textarea>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="transactionQuantity" class="form-label">
                                    <i class="fas fa-hashtag me-1"></i>Cantidad
                                </label>
                                <input type="number" class="form-control" id="transactionQuantity" value="1" min="1" step="1" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="transactionUnitPrice" class="form-label">
                                    <i class="fas fa-dollar-sign me-1"></i>Precio Unitario
                                </label>
                                <input type="number" class="form-control" id="transactionUnitPrice" placeholder="0.00" min="0" step="0.01" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="transactionTotal" class="form-label">
                                    <i class="fas fa-calculator me-1"></i>Total
                                </label>
                                <input type="text" class="form-control" id="transactionTotal" readonly style="background: rgba(196, 26, 26, 0.1); border-color: #EB1616;">
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="transactionPaymentMethod" class="form-label">
                                <i class="fas fa-credit-card me-1"></i>Forma de Pago
                            </label>
                            <select class="form-select" id="transactionPaymentMethod" required>
                                <option value="">Seleccionar forma de pago</option>
                                <option value="Efectivo">üíµ Efectivo</option>
                                <option value="TDC">üí≥ Tarjeta de Cr√©dito</option>
                                <option value="Transferencia">üè¶Transferencia</option>
                                <option value="TPV">üì± Terminal TPV</option>
                                <option value="Cheque">üìù Cheque</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Cancelar
                    </button>
                    <button type="button" class="btn btn-outline-danger" id="deleteTransactionBtn" onclick="deleteTransaction()" style="display: none;">
                        <i class="fas fa-trash me-1"></i>Eliminar
                    </button>
                    <button type="button" class="btn btn-primary" onclick="saveTransaction()">
                        <i class="fas fa-save me-1"></i>Guardar Gasto
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // ============================================================
        // VARIABLES GLOBALES
        // ============================================================
        let transactionsData = [];
        let currentPage = 1;
        const recordsPerPage = 10;
        let totalTransactions = 0;
        let currentChart = null;
        let currentChartView = 'month';

        // ============================================================
        // INICIALIZACI√ìN
        // ============================================================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Inicializando Gesti√≥n de Gastos...');
            setDefaultGastosFilter();
            loadTransactions();
            loadGastosChart();

            if (typeof getCurrentUser === 'function') {
                const user = getCurrentUser();
                if (user && user.nombre) {
                    document.getElementById('userName').textContent = user.nombre;
                    document.getElementById('userNameDisplay').textContent = user.nombre;
                }
            }
        });

        // ============================================================
        // FUNCIONES DE CARGA DE DATOS
        // ============================================================

        // Cargar transacciones desde API
        async function loadTransactions() {
            try {
                showLoadingState(true);
                
                // Construir par√°metros de filtro
                const params = new URLSearchParams();
                
                const empresa = document.getElementById('filterEmpresa').value;
                const ano = document.getElementById('filterAno').value;
                const mes = document.getElementById('filterMes').value;
                const tipo = document.getElementById('filterTipo').value || 'G'; // Solo Gastos por defecto
                
                if (empresa) params.append('empresa_id', empresa);
                if (tipo) params.append('tipo', tipo);

                // Construir rango de fechas (IGUAL que en ingresos.html)
                if (ano) {
                    const fechaInicio = mes ? `${ano}-${mes}-01` : `${ano}-01-01`;
                    const fechaFin = mes ? `${ano}-${mes}-31` : `${ano}-12-31`;
                    params.append('fechaInicio', fechaInicio);
                    params.append('fechaFin', fechaFin);
                }

                console.log('üì• Cargando ingresos con filtros:', params.toString());

                const response = await fetch(`/api/transacciones?${params.toString()}`);
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.message || 'Error cargando datos');
                }
                
                transactionsData = result.data || [];
                totalTransactions = transactionsData.length;
                currentPage = 1;
                
                console.log(`‚úÖ ${totalTransactions} Gastos cargados`);
                
                renderCurrentPage();
                updateFilterSummary();
                updatePaginationControls();
                
            } catch (error) {
                console.error('‚ùå Error cargando Gastos:', error);
                showAlert('error', `Error cargando datos: ${error.message}`);
                showEmptyState();
            }
        }

        // ============================================================
        // FUNCIONES DE RENDERIZADO
        // ============================================================

        // Renderizar p√°gina actual
        function renderCurrentPage() {
            const startIndex = (currentPage - 1) * recordsPerPage;
            const endIndex = startIndex + recordsPerPage;
            const pageData = transactionsData.slice(startIndex, endIndex);
            
            if (pageData.length === 0) {
                showEmptyState();
                return;
            }
            
            showLoadingState(false);
            
            const tableBody = document.getElementById('tableBody');
            const html = pageData.map(transaction => `
                <tr>
                    <td>${formatDate(transaction.fecha)}</td>
                    <td class="text-truncate" style="max-width: 200px;" title="${transaction.concepto}">
                        ${transaction.concepto}
                    </td>
                    <td>${transaction.socio}</td>
                    <td>
                        <span class="badge ${transaction.empresa_id == 1 ? 'bg-warning' : 'bg-info'}">
                            ${transaction.empresa_id == 1 ? 'üé∏ Rockstar Skull' : 'ü§ñ Symbiot Technologies'}
                        </span>
                    </td>
                    <td>
                        <span class="badge bg-secondary">${transaction.forma_pago}</span>
                    </td>
                    <td>
                        <span class="badge bg-success">üí∏ Gasto</span>
                    </td>
                    <td class="text-end text-success fw-bold">${formatCurrency((transaction.cantidad || 1) * (transaction.precio_unitario || 0))}</td>
                    <td class="text-center">
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary btn-sm" onclick="editTransaction(${transaction.id})" title="Editar">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-outline-danger btn-sm" onclick="confirmDelete(${transaction.id})" title="Eliminar">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
            
            tableBody.innerHTML = html;
            
            // Actualizar contadores de paginaci√≥n
            document.getElementById('showingFrom').textContent = startIndex + 1;
            document.getElementById('showingTo').textContent = Math.min(endIndex, totalTransactions);
            document.getElementById('totalRecords').textContent = totalTransactions;
        }

        // ============================================================
        // FUNCIONES DE ESTADO
        // ============================================================

        // Mostrar/ocultar loading
        function showLoadingState(show) {
            document.getElementById('loadingSpinner').style.display = show ? 'block' : 'none';
            document.getElementById('tableContainer').style.display = show ? 'none' : 'block';
            document.getElementById('paginationNav').style.display = show ? 'none' : 'block';
            document.getElementById('emptyState').style.display = 'none';
        }

        // Mostrar estado vac√≠o
        function showEmptyState() {
            document.getElementById('loadingSpinner').style.display = 'none';
            document.getElementById('tableContainer').style.display = 'none';
            document.getElementById('paginationNav').style.display = 'none';
            document.getElementById('emptyState').style.display = 'block';
        }

        // ============================================================
        // FUNCIONES DE FILTROS
        // ============================================================

        // Aplicar filtros
        function applyFilters() {
            console.log('üîç Aplicando filtros...');
            loadTransactions();
            loadGastosChart(); // Actualizar gr√°fica tambi√©n
        }

        // Limpiar filtros
        function clearFilters() {
            document.getElementById('filterEmpresa').value = '';
            document.getElementById('filterAno').value = '';
            document.getElementById('filterMes').value = '';
            document.getElementById('filterTipo').value = 'G'; // Mantener solo Gastos
            applyFilters();
        }

        // Establecer filtros por defecto para mostrar solo Gastos
        function setDefaultGastosFilter() {
            document.getElementById('filterEmpresa').value = '';
            document.getElementById('filterAno').value = '';
            document.getElementById('filterMes').value = '';
            document.getElementById('filterTipo').value = 'G'; // Solo Gastos por defecto
        }

        // Actualizar resumen de filtros
        function updateFilterSummary() {
            const empresa = document.getElementById('filterEmpresa').value;
            const ano = document.getElementById('filterAno').value;
            const mes = document.getElementById('filterMes').value;
            
            let summary = 'Mostrando üí∏ Gastos';
            
            const filters = [];
            if (empresa) {
                const empresaNombre = empresa == '1' ? 'üé∏ Rockstar Skull' : 'ü§ñ Symbiot Technologies';
                filters.push(`empresa: ${empresaNombre}`);
            }
            if (ano) filters.push(`a√±o: ${ano}`);
            if (mes) {
                const meses = ['', 'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                              'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
                filters.push(`mes: ${meses[parseInt(mes)]}`);
            }
            
            if (filters.length > 0) {
                summary += ` - ${filters.join(', ')}`;
            }
            
            document.getElementById('filterSummary').textContent = summary;
            document.getElementById('totalRegistros').textContent = totalTransactions;
        }

        // ============================================================
        // FUNCIONES DE PAGINACI√ìN
        // ============================================================

        // Cambiar p√°gina
        function changePage(direction) {
            if (direction === 'next' && currentPage * recordsPerPage < totalTransactions) {
                currentPage++;
            } else if (direction === 'prev' && currentPage > 1) {
                currentPage--;
            }
            renderCurrentPage();
            updatePaginationControls();
        }

        // Actualizar controles de paginaci√≥n
        function updatePaginationControls() {
            const totalPages = Math.ceil(totalTransactions / recordsPerPage);
            const prevPage = document.getElementById('prevPage');
            const nextPage = document.getElementById('nextPage');
            const currentPageSpan = document.getElementById('currentPageSpan');
            
            prevPage.classList.toggle('disabled', currentPage === 1);
            nextPage.classList.toggle('disabled', currentPage >= totalPages);
            currentPageSpan.textContent = currentPage;
            
            if (totalTransactions > 0) {
                document.getElementById('paginationNav').style.display = 'block';
            }
        }

        // ============================================================
        // FUNCIONES DE TRANSACCIONES (CRUD)
        // ============================================================

        let editingTransactionId = null;

        // Mostrar modal para nueva transacci√≥n
        function showAddModal() {
            editingTransactionId = null;
            document.getElementById('modalTitle').textContent = 'Nuevo Gasto';
            document.getElementById('deleteTransactionBtn').style.display = 'none';
            
            // Limpiar formulario
            document.getElementById('transactionForm').reset();
            
            // Establecer valores por defecto
            document.getElementById('transactionDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('transactionType').value = 'G'; // Gasto por defecto
            document.getElementById('transactionQuantity').value = 1;
            
            // Configurar listeners de c√°lculo
            setupCalculationListeners();
            
            const modal = new bootstrap.Modal(document.getElementById('transactionModal'));
            modal.show();
        }

        // Editar transacci√≥n existente
        function editTransaction(id) {
            const transaction = transactionsData.find(t => t.id === id);
            if (!transaction) {
                showAlert('error', 'Transacci√≥n no encontrada');
                return;
            }
            
            editingTransactionId = id;
            document.getElementById('modalTitle').textContent = 'Editar Gasto';
            document.getElementById('deleteTransactionBtn').style.display = 'inline-block';
            
            // Llenar formulario con datos existentes
            document.getElementById('transactionDate').value = transaction.fecha.split('T')[0];
            document.getElementById('transactionType').value = transaction.tipo;
            document.getElementById('transactionCompany').value = transaction.empresa_id;
            document.getElementById('transactionPartner').value = transaction.socio;
            document.getElementById('transactionConcept').value = transaction.concepto;
            document.getElementById('transactionQuantity').value = transaction.cantidad || 1;
            document.getElementById('transactionUnitPrice').value = transaction.precio_unitario;
            document.getElementById('transactionPaymentMethod').value = transaction.forma_pago;
            
            // Configurar listeners de c√°lculo
            setupCalculationListeners();
            calculateTotal();
            
            const modal = new bootstrap.Modal(document.getElementById('transactionModal'));
            modal.show();
        }

        // Configurar listeners para c√°lculo autom√°tico
        function setupCalculationListeners() {
            const quantity = document.getElementById('transactionQuantity');
            const unitPrice = document.getElementById('transactionUnitPrice');
            
            quantity.addEventListener('input', calculateTotal);
            unitPrice.addEventListener('input', calculateTotal);
        }

        // Calcular total autom√°ticamente
        function calculateTotal() {
            const quantity = parseFloat(document.getElementById('transactionQuantity').value) || 0;
            const unitPrice = parseFloat(document.getElementById('transactionUnitPrice').value) || 0;
            const total = quantity * unitPrice;
            
            document.getElementById('transactionTotal').value = formatCurrency(total);
        }

        // Guardar transacci√≥n (crear o actualizar)
        async function saveTransaction() {
            try {
                const formData = {
                    fecha: document.getElementById('transactionDate').value,
                    tipo: document.getElementById('transactionType').value,
                    empresa_id: parseInt(document.getElementById('transactionCompany').value),
                    socio: document.getElementById('transactionPartner').value,
                    concepto: document.getElementById('transactionConcept').value,
                    cantidad: parseInt(document.getElementById('transactionQuantity').value),
                    precio_unitario: parseFloat(document.getElementById('transactionUnitPrice').value),
                    forma_pago: document.getElementById('transactionPaymentMethod').value
                };
                
                // Validaciones
                if (!formData.fecha || !formData.empresa_id || !formData.socio || 
                    !formData.concepto || !formData.cantidad || !formData.precio_unitario || 
                    !formData.forma_pago) {
                    showAlert('warning', 'Por favor completa todos los campos');
                    return;
                }
                
                const url = editingTransactionId 
                    ? `/api/transacciones/${editingTransactionId}`
                    : '/api/transacciones';
                const method = editingTransactionId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert('success', editingTransactionId ? 'Gasto actualizado exitosamente' : 'Gasto creado exitosamente');
                    
                    // Cerrar modal
                    bootstrap.Modal.getInstance(document.getElementById('transactionModal')).hide();
                    
                    // Recargar datos
                    loadTransactions();
                    loadGastosChart();
                    
                } else {
                    throw new Error(result.error || 'Error en la operaci√≥n');
                }
                
            } catch (error) {
                console.error('‚ùå Error guardando gasto:', error);
                showAlert('error', `Error guardando gasto: ${error.message}`);
            }
        }

        // Confirmar eliminaci√≥n
        function confirmDelete(id) {
            if (confirm('¬øEst√°s seguro de que deseas eliminar este gasto?')) {
                deleteTransaction(id);
            }
        }

        // Eliminar transacci√≥n
        async function deleteTransaction(id = null) {
            const transactionId = id || editingTransactionId;
            if (!transactionId) return;
            
            try {
                const response = await fetch(`/api/transacciones/${transactionId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert('success', 'asto eliminado exitosamente');
                    
                    // Cerrar modal si est√° abierto
                    const modalInstance = bootstrap.Modal.getInstance(document.getElementById('transactionModal'));
                    if (modalInstance) modalInstance.hide();
                    
                    // Recargar datos
                    loadTransactions();
                    loadGastosChart();
                    
                } else {
                    throw new Error(result.error || 'Error eliminando Gasto');
                }
                
            } catch (error) {
                console.error('‚ùå Error eliminando Gasto:', error);
                showAlert('error', `Error eliminando Gasto: ${error.message}`);
            }
        }

        // Refrescar transacciones
        function refreshTransactions() {
            console.log('üîÑ Actualizando lista de Gastos...');
            loadTransactions();
            loadGastosChart();
        }

        // ============================================================
        // FUNCI√ìN DE EXPORTACI√ìN
        // ============================================================

        // Funci√≥n mejorada de exportar
        async function exportData() {
            console.log('üì• Iniciando exportaci√≥n completa de gastos...');
            
            try {
                // Mostrar indicador de carga
                const exportBtn = document.querySelector('[onclick="exportData()"]');
                const originalText = exportBtn.innerHTML;
                exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Exportando...';
                exportBtn.disabled = true;
                
                // Obtener todos los Gastos (filtrado por tipo = 'G')
                const response = await fetch('/api/transacciones?tipo=G');
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error('Error obteniendo datos para exportar');
                }
                
                const allData = result.data || [];
                
                // Headers del CSV con m√°s detalles
                const headers = [
                    'ID',
                    'Fecha', 
                    'Tipo',
                    'Empresa', 
                    'Socio/Cliente',
                    'Concepto',
                    'Cantidad',
                    'Precio Unitario',
                    'Forma de Pago',
                    'Total',
                    'Fecha Creaci√≥n'
                ];
                
                // Mapear datos para CSV
                const csvData = allData.map(t => [
                    t.id,
                    formatDate(t.fecha),
                    t.tipo === 'G' ? '' : 'Gasto',
                    t.empresa_id == 1 ? 'Rockstar Skull' : 'Symbiot Technologies',
                    t.socio,
                    `"${t.concepto.replace(/"/g, '""')}"`, // Escapar comillas dobles
                    t.cantidad,
                    t.precio_unitario,
                    t.forma_pago,
                    (t.cantidad || 1) * (t.precio_unitario || 0),
                    formatDate(t.created_at)
                ]);
                
                // Crear contenido CSV con encoding UTF-8
                const csvContent = [headers, ...csvData].map(row => row.join(',')).join('\n');
                const BOM = '\uFEFF'; // BOM para UTF-8
                
                // Crear y descargar archivo
                const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                const timestamp = new Date().toISOString().split('T')[0];
                const filename = `symbiot_gastos_${timestamp}.csv`;
                
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                // Mostrar mensaje de √©xito
                showAlert('success', `‚úÖ Archivo ${filename} exportado exitosamente (${allData.length} registros)`);
                
                console.log(`‚úÖ Exportaci√≥n completada: ${allData.length} registros`);
                
            } catch (error) {
                console.error('‚ùå Error en exportaci√≥n:', error);
                showAlert('error', `‚ùå Error exportando datos: ${error.message}`);
            } finally {
                // Restaurar bot√≥n
                const exportBtn = document.querySelector('[onclick="exportData()"]');
                if (exportBtn) {
                    exportBtn.innerHTML = originalText;
                    exportBtn.disabled = false;
                }
            }
        }

        // ============================================================
        // FUNCIONES DE GR√ÅFICA INTERACTIVA
        // ============================================================

        // Cargar y renderizar gr√°fica de gastos
        async function loadGastosChart() {
            try {
                showChartLoading(true);
                
                // Construir par√°metros basados en TODOS los filtros actuales
                const params = new URLSearchParams();
                
                const empresa = document.getElementById('filterEmpresa').value;
                const ano = document.getElementById('filterAno').value;
                const mes = document.getElementById('filterMes').value;
                const tipo = document.getElementById('filterTipo').value || 'G'; // Forzar gastos

                if (empresa) params.append('empresa_id', empresa);
                if (ano) params.append('a√±o', ano);
                if (mes) params.append('mes', mes);
                params.append('tipo', tipo); // Asegurar solo gastos

                // Construir fechas como en loadTransactions()
                if (ano) {
                    const fechaInicio = mes ? `${ano}-${mes}-01` : `${ano}-01-01`;
                    const fechaFin = mes ? `${ano}-${mes}-31` : `${ano}-12-31`;
                    params.append('fechaInicio', fechaInicio);
                    params.append('fechaFin', fechaFin);
                }
                
                console.log('üìä Cargando datos de gr√°fica con filtros:', params.toString());
                
                const response = await fetch(`/api/transacciones?${params.toString()}`);
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error('Error cargando datos para gr√°fica');
                }
                
                const data = result.data || [];
                renderGastosChart(data);
                
            } catch (error) {
                console.error('‚ùå Error cargando gr√°fica:', error);
                showChartError();
            } finally {
                showChartLoading(false);
            }
        }

        // Renderizar gr√°fica de Gastos
        function renderGastosChart(data) {
            const ctx = document.getElementById('gastosChart').getContext('2d');
            
            // Destruir gr√°fica anterior si existe
            if (currentChart) {
                currentChart.destroy();
            }
            
            // Procesar datos seg√∫n vista actual
            let processedData;
            if (currentChartView === 'month') {
                processedData = processMonthlyData(data);
            } else {
                processedData = processYearlyData(data);
            }
            
            // Configurar gr√°fica
            currentChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: processedData.labels,
                    datasets: [{
                        label: 'Gastos ($)',
                        data: processedData.values,
                        backgroundColor: 'rgba(220, 53, 69, 0.7)',
                        borderColor: 'rgba(220, 53, 69, 1)',
                        borderWidth: 2,
                        borderRadius: 6,
                        borderSkipped: false,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: 'white' }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: 'white',
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        x: {
                            ticks: { color: 'white' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    }
                }
            });
            
            // Calcular estad√≠sticas
            const total = processedData.values.reduce((sum, val) => sum + val, 0);
            const promedio = total / processedData.values.length || 0;
            const mayor = Math.max(...processedData.values) || 0;
            const transacciones = data.length;
            
            // Actualizar estad√≠sticas
            document.getElementById('totalGastosChart').textContent = formatCurrency(total);
            document.getElementById('promedioGastosChart').textContent = formatCurrency(promedio);
            document.getElementById('mayorGastoChart').textContent = formatCurrency(mayor);
            document.getElementById('totalTransaccionesChart').textContent = transacciones;
            
            showChartLoading(false);
        }

        // Procesar datos por mes
        function processMonthlyData(data) {
            const monthlyData = {};
            const months = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 
                        'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
            
            data.forEach(transaction => {
                const date = new Date(transaction.fecha);
                const year = date.getFullYear();
                const month = date.getMonth(); // 0-11
                const monthKey = `${year}-${month.toString().padStart(2, '0')}`;
                const monthLabel = `${months[month]} ${year}`;
                
                if (!monthlyData[monthKey]) {
                    monthlyData[monthKey] = { 
                        label: monthLabel, 
                        total: 0,
                        sortDate: new Date(year, month, 1) // Para ordenamiento correcto
                    };
                }
                
                monthlyData[monthKey].total += (transaction.cantidad || 1) * (transaction.precio_unitario || 0);
            });
            
            // ‚úÖ ORDENAMIENTO CRONOL√ìGICO CORRECTO
            const sortedEntries = Object.entries(monthlyData)
                .sort(([, a], [, b]) => a.sortDate - b.sortDate) // Ordenar por fecha real
                .slice(-12); // √öltimos 12 meses
            
            return {
                labels: sortedEntries.map(([_, data]) => data.label),
                values: sortedEntries.map(([_, data]) => data.total)
            };
        }

        // Procesar datos por a√±o
        function processYearlyData(data) {
            const yearlyData = {};
            
            data.forEach(transaction => {
                const year = new Date(transaction.fecha).getFullYear();
                
                if (!yearlyData[year]) {
                    yearlyData[year] = 0;
                }
                
                yearlyData[year] += (transaction.cantidad || 1) * (transaction.precio_unitario || 0);
            });
            
            const sortedEntries = Object.entries(yearlyData)
                .sort(([a], [b]) => parseInt(a) - parseInt(b));
            
            return {
                labels: sortedEntries.map(([year]) => year),
                values: sortedEntries.map(([_, total]) => total)
            };
        }

        // Cambiar vista de gr√°fica
        function setChartView(view) {
            currentChartView = view;
            
            // Actualizar botones activos
            document.getElementById('chartViewYear').classList.toggle('active', view === 'year');
            document.getElementById('chartViewMonth').classList.toggle('active', view === 'month');
            
            // Recargar gr√°fica
            loadGastosChart();
        }

        // Mostrar loading de gr√°fica
        function showChartLoading(show) {
            document.getElementById('chartLoading').style.display = show ? 'block' : 'none';
            document.getElementById('chartContainer').style.display = show ? 'none' : 'block';
            document.getElementById('chartSummary').style.display = show ? 'none' : 'block';
            document.getElementById('chartError').style.display = 'none';
        }

        // Mostrar error en gr√°fica
        function showChartError() {
            document.getElementById('chartLoading').style.display = 'none';
            document.getElementById('chartContainer').style.display = 'none';
            document.getElementById('chartSummary').style.display = 'none';
            document.getElementById('chartError').style.display = 'block';
        }

        // ============================================================
        // FUNCIONES DE UTILIDAD
        // ============================================================

        // Formatear fecha
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('es-ES', {
                day: '2-digit',
                month: '2-digit', 
                year: 'numeric'
            });
        }

        // Formatear moneda
        function formatCurrency(amount) {
            return new Intl.NumberFormat('es-MX', {
                style: 'currency',
                currency: 'MXN',
                minimumFractionDigits: 2
            }).format(amount);
        }

        // Mostrar alertas al usuario
        function showAlert(type, message) {
            // Crear el contenedor de alerta si no existe
            let alertContainer = document.getElementById('alertContainer');
            if (!alertContainer) {
                alertContainer = document.createElement('div');
                alertContainer.id = 'alertContainer';
                alertContainer.className = 'position-fixed top-0 end-0 p-3';
                alertContainer.style.zIndex = '9999';
                document.body.appendChild(alertContainer);
            }
            
            // Tipos de alerta
            const alertTypes = {
                'success': { class: 'alert-success', icon: 'fa-check-circle' },
                'error': { class: 'alert-danger', icon: 'fa-exclamation-circle' },
                'warning': { class: 'alert-warning', icon: 'fa-exclamation-triangle' },
                'info': { class: 'alert-info', icon: 'fa-info-circle' }
            };
            
            const alertType = alertTypes[type] || alertTypes['info'];
            
            // Crear alerta
            const alertElement = document.createElement('div');
            alertElement.className = `alert ${alertType.class} alert-dismissible fade show`;
            alertElement.innerHTML = `
                <i class="fas ${alertType.icon} me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            alertContainer.appendChild(alertElement);
            
            // Auto-eliminar despu√©s de 5 segundos
            setTimeout(() => {
                if (alertElement.parentNode) {
                    alertElement.remove();
                }
            }, 5000);
        }

       function showComingSoon(feature) {
            console.log(`üöß Funci√≥n ${feature} pr√≥ximamente...`);
            showAlert('info', `üìã ${feature} estar√° disponible en la pr√≥xima fase del desarrollo`);
        }

        // üë§ Cargar usuario actual
        async function loadCurrentUser() {
            try {
                console.log('üë§ Cargando usuario actual...');
                
                const response = await fetch('/api/user');
                const data = await response.json();
                
                if (data.success) {
                    currentUser = data.user;
                    document.getElementById('userName').textContent = currentUser.nombre;
                    document.getElementById('userNameDisplay').textContent = currentUser.nombre;
                    
                    // Actualizar empresa en banner si existe el elemento
                    const userCompanyElement = document.getElementById('userCompany');
                    if (userCompanyElement) {
                        userCompanyElement.textContent = currentUser.empresa;
                    }
                    
                    console.log('‚úÖ Usuario cargado:', currentUser.nombre);
                } else {
                    throw new Error('No hay sesi√≥n activa');
                }
                
            } catch (error) {
                console.error('‚ùå Error cargando usuario:', error);
                throw error;
            }
        }

        async function logout() {
            if (confirm('¬øEst√° seguro que desea cerrar sesi√≥n?')) {
                try {
                    console.log('üö™ Cerrando sesi√≥n...');
                    
                    const response = await fetch('/api/logout', { 
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        }
                    });
                    
                    console.log('üì§ Respuesta logout:', response.status);
                    
                    // Intentar obtener respuesta JSON
                    let data = null;
                    try {
                        data = await response.json();
                    } catch (parseError) {
                        console.log('‚ö†Ô∏è No se pudo parsear respuesta JSON');
                    }
                    
                    if (response.ok || response.status === 200) {
                        console.log('‚úÖ Logout exitoso');
                        localStorage.removeItem('rememberedEmail');
                        window.location.href = 'login.html';
                    } else {
                        throw new Error('Error en logout del servidor');
                    }
                    
                } catch (error) {
                    console.error('‚ùå Error en logout:', error);
                    // Forzar redirecci√≥n incluso si hay error
                    showAlert('warning', 'Cerrando sesi√≥n...');
                    localStorage.removeItem('rememberedEmail');
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 1000);
                }
            }
        }

        console.log('‚úÖ Sistema de gesti√≥n de Gastos configurado');

        // üîê Verificaci√≥n de autenticaci√≥n al cargar p√°gina
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                console.log('üöÄ Inicializando p√°gina de Gastos...');
                
                // Cargar usuario actual
                await loadCurrentUser();
                
                // Actualizar fecha actual en banner
                const currentDateElement = document.getElementById('currentDate');
                if (currentDateElement) {
                    const now = new Date();
                    currentDateElement.textContent = now.toLocaleDateString('es-ES', {
                        day: 'numeric',
                        month: 'long',
                        year: 'numeric'
                    });
                }
                
                console.log('‚úÖ P√°gina inicializada correctamente');
                
            } catch (error) {
                console.error('‚ùå Error de autenticaci√≥n:', error);
                console.log('üîì Redirigiendo al login...');
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 2000);
            }
        });
        
    </script>
    
    <!-- Script de verificaci√≥n de autenticaci√≥n -->
    <script src="assets/auth-check.js"></script>
</body>
</html>