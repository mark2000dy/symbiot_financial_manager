<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Dashboard - Sistema de Gastos Symbiot</title>
    
    <!-- PWA Configuration -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#191C24">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
    
    <style>
        body {
            background: linear-gradient(135deg, #000 0%, #191C24 50%, #000 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: white;
        }
        
        .navbar {
            background: rgba(25, 28, 36, 0.95) !important;
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .navbar-brand {
            color: #EB1616 !important;
            font-weight: bold;
            font-size: 1.5rem;
        }
        
        .navbar-nav .nav-link {
            color: rgba(255, 255, 255, 0.8) !important;
            transition: color 0.3s ease;
        }
        
        .navbar-nav .nav-link:hover {
            color: #EB1616 !important;
        }
        
        .main-content {
            padding: 2rem 0;
        }

        .text-muted, .small, .stat-label {
            color: #E4E6EA !important; /* Gris mucho más claro */
        }
        
        .stat-card {
            background: rgba(25, 28, 36, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            backdrop-filter: blur(10px);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .stat-icon {
            font-size: 2.5rem;
        }
        
        /* 🎨 MEJORA: Textos más claros para mejor visibilidad */
        .stat-card .card-title {
            color: #B0B3B8 !important; /* Gris más claro */
            font-weight: 500;
        }
        
        .stat-card h4 {
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .card {
            background: rgba(25, 28, 36, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }
        
        .card-header {
            background: rgba(235, 22, 22, 0.1);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .table-dark {
            background: transparent;
        }
        
        .table-dark tbody tr {
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .btn-primary {
            background: linear-gradient(45deg, #EB1616, #FF4444);
            border: none;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            background: linear-gradient(45deg, #FF4444, #EB1616);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(235, 22, 22, 0.4);
        }
        
        .btn-outline-primary {
            border-color: #EB1616;
            color: #EB1616;
        }
        
        .btn-outline-primary:hover {
            background-color: #EB1616;
            border-color: #EB1616;
        }
        
        .badge-success {
            background-color: #28a745 !important;
        }
        
        .badge-danger {
            background-color: #dc3545 !important;
        }
        
        .loading-spinner {
            display: none;
            text-align: center;
            padding: 2rem;
        }
        
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: rgba(255, 255, 255, 0.6);
        }
        
        .welcome-banner {
            background: linear-gradient(135deg, rgba(235, 22, 22, 0.2), rgba(255, 68, 68, 0.1));
            border: 1px solid rgba(235, 22, 22, 0.3);
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        
        /* 🎨 MEJORA: Texto empresa y fecha más visible */
        .welcome-banner .text-muted {
            color: #B0B3B8 !important; /* Gris más claro */
            opacity: 0.9;
        }
        
        .transaction-row {
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        
        .transaction-row:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }
        
        .alert {
            border: none;
            border-radius: 10px;
        }
        
        /* 🎨 Modal personalizado */
        .modal-content {
            background: rgba(25, 28, 36, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            color: white;
        }
        
        .modal-header {
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .modal-footer {
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .form-control {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
        }
        
        .form-control:focus {
            background: rgba(255, 255, 255, 0.15);
            border-color: #EB1616;
            box-shadow: 0 0 0 0.2rem rgba(235, 22, 22, 0.25);
            color: white;
        }
        
        .form-control::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }
        
        .form-label {
            color: #B0B3B8;
            font-weight: 500;
        }
        
        .form-select {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
        }
        
        .form-select option {
            background: #191C24;
            color: white;
        }
        
        .form-select:focus {
            background: rgba(255, 255, 255, 0.15);
            border-color: #EB1616;
            color: white;
        }

        /* Dropdown menu styling */
        .dropdown-menu {
            background: rgba(25, 28, 36, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }
        
        .dropdown-item {
            color: rgba(255, 255, 255, 0.8);
        }
        
        .dropdown-item:hover {
            background-color: rgba(235, 22, 22, 0.2);
            color: white;
        }

        /* Fix para btn-close en modal */
        .btn-close-white {
            background: transparent url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%23ffffff'%3e%3cpath d='m.235.227 7.618 7.554L15.47.226a.75.75 0 1 1 1.06 1.06L8.912 8.84l7.618 7.618a.75.75 0 1 1-1.061 1.06L7.85 9.901.232 17.52a.75.75 0 0 1-1.061-1.06L6.789 8.84.17 1.286A.75.75 0 1 1 1.231.227z'/%3e%3c/svg%3e") center/1em auto no-repeat;
        }
        .company-stats .stat-item {
            padding: 0.5rem;
        }

        .company-stats .stat-number {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .company-stats .stat-label {
            font-size: 0.85rem;
            color: #E4E6EA;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .student-stat h4 {
            font-size: 2rem;
            font-weight: 700;
        }

        .alert-warning {
            background-color: rgba(255, 193, 7, 0.1);
            border-color: rgba(255, 193, 7, 0.3);
            color: #ffc107;
        }

        .alert-danger {
            background-color: rgba(220, 53, 69, 0.1);
            border-color: rgba(220, 53, 69, 0.3);
            color: #dc3545;
        }

        .alert-heading {
            color: inherit;
            font-size: 1rem;
            font-weight: 600;
        }

        #rockstarSkullWidgets .card {
            transition: all 0.3s ease;
        }

        #rockstarSkullWidgets .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .company-stats .stat-label {
            color: #E4E6EA !important;
        }

        #teachersOverview .text-muted {
            color: #B8B9BA !important;
        }

        #rockstarSkullWidgets .card-body small {
            color: #E4E6EA !important;
        }

        /* 🎯 Interactividad para números de alumnos */
        .student-stat:hover {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .instrument-card {
            transition: all 0.3s ease;
        }

        .instrument-card:hover {
            transform: translateY(-3px);
            background: rgba(255, 255, 255, 0.1) !important;
        }

        /* Mejorar indicadores del selector */
        .stat-item {
            transition: all 0.3s ease;
        }

        .stat-item:hover {
            transform: translateY(-2px);
        }

        .student-row {
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .student-row:hover {
            background-color: rgba(255, 255, 255, 0.08) !important;
        }

        .table-sm td {
            padding: 0.4rem;
            font-size: 0.85rem;
        }

        .table-sm th {
            padding: 0.5rem 0.4rem;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-select-sm {
            font-size: 0.85rem;
            padding: 0.25rem 0.5rem;
        }

        .alert-info {
            background-color: rgba(13, 202, 240, 0.1);
            border-color: rgba(13, 202, 240, 0.3);
            color: #0dcaf0;
        }

        .badge {
            font-size: 0.7rem;
        }

        .modal-lg {
            max-width: 800px;
        }

        #studentDetailModal .table-sm td:first-child {
            width: 140px;
            font-weight: 500;
            color: #B0B3B8;
        }

        .pagination-sm .page-link {
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
        }

        /* 🔧 FIX: Modales con scroll interno para formularios largos */
        .modal-body {
            max-height: 70vh;
            overflow-y: auto;
        }

        .modal-dialog.modal-xl .modal-body {
            max-height: 75vh;
        }

        /* Asegurar que el footer siempre esté visible */
        .modal-footer {
            position: sticky;
            bottom: 0;
            background: rgba(25, 28, 36, 0.95);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            z-index: 1000;
        }

    </style>

    <style>
    /* 🎯 MEJORAR CONTRASTE DE TEXTOS GRISES */
    .text-muted {
        color: #C8CCD0 !important; /* Más claro que el original Bootstrap */
    }

    /* 🎯 MEJORAR TEXTO SECUNDARIO */
    small.text-muted, 
    .small.text-muted {
        color: #D1D5DB !important;
        font-weight: 500 !important;
    }

    /* 🎯 MEJORAR CONTRASTE DE ELEMENTOS ESPECÍFICOS */
    .card-body small {
        color: #C8CCD0 !important;
        font-weight: 500 !important;
    }

    /* 🎯 SELECTOR DE EMPRESA - LABELS MEJORADOS */
    .stat-label {
        color: #D1D5DB !important;
        font-weight: 600 !important;
        font-size: 0.8em !important;
    }

    /* 🎯 WIDGET MAESTROS - ESPECIALIDADES MÁS VISIBLES */
    .teacher-info small,
    .maestro-especialidad {
        color: #C8CCD0 !important;
        font-weight: 500 !important;
    }

    /* 🎯 ALERTAS DE PAGOS - TEXTO MÁS VISIBLE */
    .alert small {
        color: #E5E7EB !important;
        font-weight: 500 !important;
    }

    /* 🎯 TABLA DE ALUMNOS - TEXTO SECUNDARIO */
    .table small {
        color: #D1D5DB !important;
        font-weight: 500 !important;
    }

    /* 🎯 BADGES Y ELEMENTOS INFORMATIVOS */
    .badge small {
        color: #F3F4F6 !important;
    }

    /* 🎯 DISTRIBUCIÓN DE CLASES - MEJORES CONTRASTES */
    .class-item small {
        color: #C8CCD0 !important;
        font-weight: 500 !important;
    }

    .class-stats small {
        color: #D1D5DB !important;
        font-weight: 500 !important;
    }

    /* 🎯 ELEMENTOS DE FORMULARIO - PLACEHOLDERS MÁS VISIBLES */
    .form-control::placeholder {
        color: #9CA3AF !important;
        opacity: 1 !important;
    }

    /* 🎯 TEXTO DE AYUDA Y HINTS */
    .form-text {
        color: #C8CCD0 !important;
    }

    /* 🎯 ICONOS CON MEJOR VISIBILIDAD */
    .fas.text-muted,
    .far.text-muted {
        color: #C8CCD0 !important;
    }

    /* 🎯 LOADING STATES CON MEJOR CONTRASTE */
    .loading-spinner p {
        color: #E5E7EB !important;
        font-weight: 500 !important;
    }

    /* 🎯 ESTADOS VACÍOS MÁS VISIBLES */
    .empty-state small {
        color: #D1D5DB !important;
        font-weight: 500 !important;
    }

    /* 🎯 HOVER EFFECTS MEJORADOS */
    .teacher-item:hover,
    .class-item:hover {
        background: rgba(255,255,255,0.08) !important;
        border-radius: 6px;
        transition: background 0.2s ease;
    }

    /* 🎯 BORDES MÁS SUAVES */
    .card {
        border: 1px solid rgba(255,255,255,0.1) !important;
    }

    /* 🎯 SEPARADORES MÁS VISIBLES */
    hr {
        border-top: 1px solid rgba(255,255,255,0.15) !important;
    }

    /* 🎯 ELEMENTOS ESPECÍFICOS DE ROCKSTAR SKULL */
    .student-stat small {
        color: #E4E6EA !important;
        font-weight: 600 !important;
    }

    .instrument-card small {
        color: #D1D5DB !important;
        font-weight: 500 !important;
    }

    /* 🎯 RESPONSIVE - MEJORAR EN PANTALLAS PEQUEÑAS */
    @media (max-width: 768px) {
        .stat-label {
            font-size: 0.75em !important;
        }
        
        small.text-muted {
            font-size: 0.8em !important;
        }
    }

    /* 🎯 EFECTOS PARA WIDGET ALUMNOS INSCRITOS */
    .student-stat {
        transition: all 0.3s ease;
        border-radius: 8px;
        padding: 10px;
        cursor: pointer;
    }

    .student-stat:hover {
        background: rgba(255,255,255,0.05) !important;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }

    /* 🎯 ESTADO ACTIVO DEL FILTRO */
    .student-stat.active-filter {
        background: rgba(13, 110, 253, 0.2) !important;
        border: 2px solid rgba(13, 110, 253, 0.5) !important;
        border-radius: 8px !important;
        transition: all 0.3s ease !important;
        transform: scale(1.02);
        box-shadow: 0 0 20px rgba(13, 110, 253, 0.3);
    }

    .student-stat.active-filter:hover {
        background: rgba(13, 110, 253, 0.3) !important;
        border-color: rgba(13, 110, 253, 0.7) !important;
    }

    /* 🎯 ANIMACIÓN DE PULSO PARA ELEMENTO ACTIVO */
    .student-stat.active-filter::before {
        content: '';
        position: absolute;
        top: -2px;
        left: -2px;
        right: -2px;
        bottom: -2px;
        background: linear-gradient(45deg, rgba(13, 110, 253, 0.3), rgba(13, 202, 240, 0.3));
        border-radius: 10px;
        z-index: -1;
        opacity: 0;
        animation: pulse-border 2s infinite;
    }

    @keyframes pulse-border {
        0% { opacity: 0; transform: scale(1); }
        50% { opacity: 1; transform: scale(1.02); }
        100% { opacity: 0; transform: scale(1); }
    }

    /* 🎯 MEJORAS EN DISTRIBUCIÓN DE CLASES */
    .class-item {
        position: relative;
        overflow: hidden;
    }

    .class-item::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        height: 100%;
        width: 4px;
        background: linear-gradient(to bottom, #0d6efd, #20c997);
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .class-item:hover::before {
        opacity: 1;
    }

    /* 🎯 ANIMACIÓN DE ENTRADA PARA ELEMENTOS FILTRADOS */
    .class-item {
        animation: fadeInUp 0.4s ease-out;
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* 🎯 BADGES MEJORADOS PARA CLASES */
    .class-item .badge {
        position: relative;
        overflow: hidden;
    }

    .class-item .badge::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
        transition: left 0.6s ease;
    }

    .class-item:hover .badge::before {
        left: 100%;
    }

    /* 🎯 ALERTAS DE FILTRO MEJORADAS */
    .alert {
        border-radius: 10px;
        border: none;
        position: relative;
        overflow: hidden;
    }

    .alert::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 2px;
        background: linear-gradient(90deg, #0d6efd, #20c997, #ffc107);
        animation: progress-line 2s ease-in-out infinite;
    }

    @keyframes progress-line {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(100%); }
    }

    /* 🎯 CONTADORES CON MEJOR VISIBILIDAD */
    .student-stat h4 {
        font-size: 2.2em !important;
        font-weight: 700 !important;
        text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        transition: all 0.3s ease;
    }

    .student-stat:hover h4 {
        transform: scale(1.1);
        text-shadow: 0 4px 8px rgba(0,0,0,0.4);
    }

    /* 🎯 ETIQUETAS DEL TOTAL DE ESTUDIANTES */
    .badge.bg-primary {
        font-size: 1.1em !important;
        padding: 8px 12px !important;
        border-radius: 20px !important;
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .badge.bg-primary:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 12px rgba(13, 110, 253, 0.4);
    }

    /* 🎯 RESPONSIVE - EFECTOS EN MÓVILES */
    @media (max-width: 768px) {
        .student-stat {
            margin-bottom: 10px;
        }
        
        .student-stat h4 {
            font-size: 1.8em !important;
        }
        
        .class-item {
            margin-bottom: 15px !important;
            padding: 15px !important;
        }
    }

    /* 🎯 THEME TRANSITIONS */
    .class-item, .student-stat, .badge {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* 🎯 LOADING STATES PARA FILTROS */
    .filter-loading {
        position: relative;
    }

    .filter-loading::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.1);
        border-radius: 8px;
        animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
        0%, 100% { opacity: 0.3; }
        50% { opacity: 0.7; }
    }

    /* Widget Maestros - Mejoras visuales */
    .teachers-grid {
        display: grid !important;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)) !important;
        gap: 15px !important;
        padding: 5px !important;
    }

    .teacher-card {
        transition: all 0.3s ease;
        position: relative;
        min-height: 140px;
        margin-bottom: 0 !important;
    }

    .teacher-card:hover {
        background: rgba(255,255,255,0.15) !important;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }

    /* Indicadores de estado */
    .text-success {
        color: #28a745 !important;
    }

    .text-danger {
        color: #dc3545 !important;
    }

    .text-info {
        color: #17a2b8 !important;
    }

    .text-warning {
        color: #ffc107 !important;
    }

    .text-white {
        color: #ffffff !important;
    }

    .text-light {
        color: #f8f9fa !important;
    }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/gastos">
                <img src="assets/images/Symbiot_logo_dark_horizon.png" alt="SYMBIOT Logo" style="height: 30px; margin-right: 8px;">
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="dashboard.html" style="color: #dc3545 !important; font-weight: bold;">
                            <i class="fas fa-tachometer-alt me-1"></i>Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="gastos.html">
                            <i class="fas fa-money-bill-wave me-1"></i>Gastos
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="ingresos.html">
                            <i class="fas fa-coins me-1"></i>Ingresos
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="event.preventDefault(); showComingSoon('Reportes');">
                            <i class="fas fa-chart-bar me-1"></i>Reportes
                        </a>
                    </li>
                </ul>
                
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user-circle me-1"></i>
                            <span id="userName">Usuario</span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="#" onclick="event.preventDefault(); showComingSoon('Perfil');"><i class="fas fa-user me-2"></i>Perfil</a></li>
                            <li><a class="dropdown-item" href="#" onclick="event.preventDefault(); showComingSoon('Configuración');"><i class="fas fa-cog me-2"></i>Configuración</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="event.preventDefault(); logout();"><i class="fas fa-sign-out-alt me-2"></i>Cerrar Sesión</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid main-content">
        <!-- Welcome Banner -->
        <div class="welcome-banner" id="welcomeBanner">
            <h4 class="mb-1">¡Bienvenido, <span id="userNameDisplay">Usuario</span>!</h4>
            <p class="mb-0 text-muted">
                <i class="fas fa-building me-1"></i>
                <span id="userCompany">Cargando...</span> • 
                <span id="currentDate"></span>
            </p>
        </div>

        <!-- Alert Container -->
        <div id="alertContainer"></div>

        <!-- Statistics Cards -->
        <div class="row mb-4">
            <!-- Balance Total -->
            <div class="col-sm-6 col-xl-3 mb-3">
                <div class="card stat-card h-100">
                    <div class="card-body d-flex align-items-center">
                        <i class="fas fa-wallet stat-icon text-info me-3"></i>
                        <div>
                            <h6 class="card-title">Balance Total</h6>
                            <h4 class="text-info mb-0" id="balanceTotal">
                                <div class="loading-spinner">
                                    <i class="fas fa-spinner fa-spin"></i>
                                </div>
                            </h4>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Total Ingresos -->
            <div class="col-sm-6 col-xl-3 mb-3">
                <div class="card stat-card h-100">
                    <div class="card-body d-flex align-items-center">
                        <i class="fas fa-arrow-up stat-icon text-success me-3"></i>
                        <div>
                            <h6 class="card-title">Total Ingresos</h6>
                            <h4 class="text-success mb-0" id="totalIngresos">
                                <div class="loading-spinner">
                                    <i class="fas fa-spinner fa-spin"></i>
                                </div>
                            </h4>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Total Gastos -->
            <div class="col-sm-6 col-xl-3 mb-3">
                <div class="card stat-card h-100">
                    <div class="card-body d-flex align-items-center">
                        <i class="fas fa-arrow-down stat-icon text-danger me-3"></i>
                        <div>
                            <h6 class="card-title">Total Gastos</h6>
                            <h4 class="text-danger mb-0" id="totalGastos">
                                <div class="loading-spinner">
                                    <i class="fas fa-spinner fa-spin"></i>
                                </div>
                            </h4>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Este Mes -->
            <div class="col-sm-6 col-xl-3 mb-3">
                <div class="card stat-card h-100">
                    <div class="card-body d-flex align-items-center">
                        <i class="fas fa-calendar stat-icon text-warning me-3"></i>
                        <div>
                            <h6 class="card-title">Este Mes</h6>
                            <h4 class="text-warning mb-0" id="esteMes">
                                <div class="loading-spinner">
                                    <i class="fas fa-spinner fa-spin"></i>
                                </div>
                            </h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========================================= -->
        <!-- WIDGET SELECTOR DE EMPRESAS -->  
        <!-- Insertar DESPUÉS del Welcome Banner en dashboard.html -->
        <!-- ========================================= -->

        <!-- Company Selector Widget -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="text-white mb-0">
                            <i class="fas fa-building me-2"></i>Selector de Empresa
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-4">
                                <label for="companyFilter" class="form-label">
                                    <i class="fas fa-filter me-1"></i>Filtrar por Empresa
                                </label>
                                <select class="form-select" id="companyFilter" onchange="handleCompanyChange()">
                                    <option value="">🏢 Todas las Empresas</option>
                                    <option value="2">🔬 Symbiot Technologies</option>
                                    <option value="1">🎸 RockstarSkull Academia</option>
                                </select>
                            </div>
                            <div class="col-md-8">
                                <div class="company-stats d-flex justify-content-around">
                                    <div class="stat-item text-center">
                                        <div class="stat-number text-info" id="companyTransactions">-</div>
                                        <div class="stat-label">Transacciones</div>
                                    </div>
                                    <div class="stat-item text-center" id="groupClassesIndicator" style="display: none;">
                                        <div class="stat-number text-primary" id="groupClasses">-</div>
                                        <div class="stat-label">Clases Grupales</div>
                                    </div>
                                    <div class="stat-item text-center" id="individualClassesIndicator" style="display: none;">
                                        <div class="stat-number text-success" id="individualClasses">-</div>
                                        <div class="stat-label">Clases Individuales</div>
                                    </div>
                                    <div class="stat-item text-center" id="currentStudentsIndicator" style="display: none;">
                                        <div class="stat-number text-warning" id="currentStudents">-</div>
                                        <div class="stat-label">Al Corriente</div>
                                    </div>
                                    <div class="stat-item text-center" id="pendingStudentsIndicator" style="display: none;">
                                        <div class="stat-number text-danger" id="pendingStudents">-</div>
                                        <div class="stat-label">Pendientes</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- RockstarSkull Specific Widgets (Hidden by default) -->
        <div id="rockstarSkullWidgets" style="display: none;">
            <!-- Students Overview Widget -->
            <div class="row mb-4">
                <div class="col-xl-6 mb-3">
                    <div class="card h-100">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="text-white mb-0">
                                <i class="fas fa-users me-2"></i>Alumnos Inscritos
                            </h6>
                            <span class="badge bg-primary" id="totalStudents" style="cursor: pointer;" onclick="filterStudentsByStatus('all')">0</span>
                        </div>
                        <div class="card-body">
                            <div class="row text-center">
                                <div class="col-6">
                                    <div class="student-stat" style="cursor: pointer;" onclick="filterStudentsByStatus('active')">
                                        <h4 class="text-success mb-1" id="activeStudents">0</h4>
                                        <small style="color: #E4E6EA !important;">Activos</small>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="student-stat" style="cursor: pointer;" onclick="filterStudentsByStatus('inactive')">
                                        <h4 class="text-danger mb-1" id="inactiveStudents">0</h4>
                                        <small style="color: #E4E6EA !important;">Bajas</small>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Classes Distribution -->
                            <div class="mt-3">
                                <small style="color: #E4E6EA !important;">Distribución por Clase:</small>
                                <div id="classDistribution" class="mt-2">
                                    <!-- Se llena dinámicamente con mejor diseño -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Teachers Overview Widget -->
                <div class="col-xl-6 mb-3">
                    <div class="card h-100">
                        <div class="card-header">
                            <h6 class="text-white mb-0">
                                <i class="fas fa-chalkboard-teacher me-2"></i>Maestros Activos
                            </h6>
                        </div>
                        <div class="card-body">
                            <div id="teachersOverview">
                                <!-- Se llena dinámicamente -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Payment Alerts Widget -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="text-white mb-0">
                                <i class="fas fa-exclamation-triangle me-2"></i>Alertas de Pagos
                            </h6>
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="refreshTransactions()" title="Actualizar">
                                <i class="fas fa-sync-alt me-1"></i>Actualizar
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="alert alert-warning" role="alert">
                                        <h6 class="alert-heading">
                                            <i class="fas fa-clock me-2"></i>Próximos a Vencer
                                        </h6>
                                        <div id="upcomingPayments">
                                            <small class="text-muted">Cargando...</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="alert alert-danger" role="alert">
                                        <h6 class="alert-heading">
                                            <i class="fas fa-exclamation-circle me-2"></i>Pagos Vencidos (+5 días)
                                        </h6>
                                        <div id="overduePayments">
                                            <small class="text-muted">Cargando...</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- ========================================= -->
            <!-- WIDGET SISTEMA DE GESTIÓN DE ALUMNOS -->
            <!-- Insertar DENTRO del div "rockstarSkullWidgets" -->
            <!-- DESPUÉS de las alertas de pagos -->
            <!-- ========================================= -->

            <!-- Students Management System -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="text-white mb-0">
                                <i class="fas fa-graduation-cap me-2"></i>Gestión de Alumnos - RockstarSkull
                            </h6>
                            <div class="d-flex gap-2">
                                <button class="btn btn-sm btn-outline-info" onclick="exportStudentsList()">
                                    <i class="fas fa-download me-1"></i>Exportar
                                </button>
                                <button class="btn btn-sm btn-outline-primary" onclick="refreshStudentsList()">
                                    <i class="fas fa-sync-alt me-1"></i>Actualizar
                                </button>
                                <button class="btn btn-sm btn-success" onclick="showAddStudentModal()">
                                    <i class="fas fa-plus me-1"></i>Nuevo Alumno
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <!-- Filtros -->
                            <div class="row mb-3">
                                <div class="col-md-3">
                                    <label class="form-label">
                                        <i class="fas fa-filter me-1"></i>Filtrar por Maestro
                                    </label>
                                    <select class="form-select form-select-sm" id="teacherFilter" onchange="filterStudents()">
                                        <option value="">👨‍🏫 Todos los Maestros</option>
                                        <!-- ✅ USAR IDs EN LUGAR DE NOMBRES -->
                                        <option value="1">🎸 Hugo Vazquez</option>
                                        <option value="2">🥁 Julio Olvera</option>
                                        <option value="3">🥁 Demian Andrade</option>
                                        <option value="4">🎸 Irwin Hernandez</option>
                                        <option value="5">🎤 Nahomy Perez</option>
                                        <option value="6">🎸 Luis Blanquet</option>
                                        <option value="7">🎹 Manuel Reyes</option>
                                        <option value="8">🎹 Harim Lopez</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">
                                        <i class="fas fa-toggle-on me-1"></i>Estatus
                                    </label>
                                    <select class="form-select form-select-sm" id="statusFilter" onchange="filterStudents()">
                                        <option value="">📊 Todos los Estatus</option>
                                        <option value="Activo">✅ Activos</option>
                                        <option value="Baja">❌ Bajas</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">
                                        <i class="fas fa-music me-1"></i>Instrumento
                                    </label>
                                    <select class="form-select form-select-sm" id="instrumentFilter" onchange="filterStudents()">
                                        <option value="">🎼 Todos los Instrumentos</option>
                                        <option value="Guitarra">🎸 Guitarra</option>
                                        <option value="Teclado">🎹 Teclado</option>
                                        <option value="Batería">🥁 Batería</option>
                                        <option value="Bajo">🎸 Bajo</option>
                                        <option value="Canto">🎤 Canto</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">
                                        <i class="fas fa-calendar-exclamation me-1"></i>Pagos
                                    </label>
                                    <select class="form-select form-select-sm" id="paymentFilter" onchange="filterStudents()">
                                        <option value="">💰 Todos los Pagos</option>
                                        <option value="current">✅ Al Corriente</option>
                                        <option value="upcoming">⚠️ Próximos (3 días)</option>
                                        <option value="overdue">🚨 Vencidos (+5 días)</option>
                                        <option value="inactive">❌ Alumnos Inactivos</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Summary Stats -->
                            <div class="row mb-3">
                                <div class="col-12">
                                    <div class="alert alert-info d-flex justify-content-between align-items-center py-2">
                                        <div>
                                            <strong>Filtros Aplicados:</strong>
                                            <span id="filterSummary">Mostrando todos los alumnos</span>
                                        </div>
                                        <div>
                                            <span class="badge bg-primary" id="filteredCount">100</span> de 
                                            <span id="totalCount">100</span> alumnos
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Students Table -->
                            <div class="table-responsive" id="studentsTableContainer">
                                <table class="table table-dark table-hover table-sm">
                                    <thead>
                                        <tr>
                                            <th><i class="fas fa-user me-1"></i>Alumno</th>
                                            <th><i class="fas fa-birthday-cake me-1"></i>Edad</th>
                                            <th><i class="fas fa-chalkboard-teacher me-1"></i>Maestro</th>
                                            <th><i class="fas fa-music me-1"></i>Clase</th>
                                            <th><i class="fas fa-toggle-on me-1"></i>Inscripción</th>
                                            <th><i class="fas fa-dollar-sign me-1"></i>Mensualidad</th>
                                            <th><i class="fas fa-calendar-day me-1"></i>Próximo Pago</th>
                                            <th><i class="fas fa-exclamation-triangle me-1"></i>Alerta</th>
                                            <th><i class="fas fa-check-circle me-1"></i>Estatus</th>
                                            <th><i class="fas fa-cogs me-1"></i>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="studentsTableBody">
                                        <tr>
                                            <td colspan="10" class="text-center py-4">
                                                <i class="fas fa-spinner fa-spin fa-2x text-primary"></i>
                                                <p class="mt-2 mb-0">Cargando lista de alumnos...</p>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <!-- Loading State -->
                            <div id="studentsLoadingState" class="text-center py-4" style="display: none;">
                                <i class="fas fa-spinner fa-spin fa-2x text-primary"></i>
                                <p class="mt-2 mb-0">Cargando alumnos...</p>
                            </div>

                            <!-- Empty State -->
                            <div id="studentsEmptyState" class="text-center py-4" style="display: none;">
                                <i class="fas fa-search fa-2x text-muted"></i>
                                <p class="mt-2 mb-0 text-muted">No se encontraron alumnos con los filtros aplicados</p>
                                <button class="btn btn-sm btn-outline-info mt-2" onclick="refreshStudentsList()">
                                    <i class="fas fa-sync-alt me-1"></i>Actualizar
                                </button>
                            </div>

                            <!-- Paginación CORRECTAMENTE UBICADA -->
                            <nav aria-label="Paginación de alumnos" class="mt-3" id="studentsPaginationNav" style="display: none;">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <small class="text-white">
                                            Mostrando <span id="studentsShowingFrom">1</span> - <span id="studentsShowingTo">10</span> 
                                            de <span id="studentsTotalRecords">0</span> alumnos
                                        </small>
                                    </div>
                                    <ul class="pagination pagination-sm mb-0" id="studentsPaginationList">
                                        <!-- Se genera dinámicamente -->
                                    </ul>
                                </div>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        

        <!-- ========================================= -->
        <!-- MODAL DETALLE DE ALUMNO -->
        <!-- ========================================= -->
        <div class="modal fade" id="studentDetailModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-user-graduate me-2"></i>
                            <span id="studentModalName">Detalle del Alumno</span>
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-primary">📋 Información General</h6>
                                <table class="table table-dark table-sm">
                                    <tr><td><strong>Nombre:</strong></td><td id="modalStudentName">-</td></tr>
                                    <tr><td><strong>Edad:</strong></td><td id="modalStudentAge">-</td></tr>
                                    <tr><td><strong>Clase:</strong></td><td id="modalStudentClass">-</td></tr>
                                    <tr><td><strong>Maestro:</strong></td><td id="modalStudentTeacher">-</td></tr>
                                    <tr><td><strong>Horario:</strong></td><td id="modalStudentSchedule">-</td></tr>
                                    <tr><td><strong>Estatus:</strong></td><td id="modalStudentStatus">-</td></tr>
                                    <tr><td><strong>Teléfono:</strong></td><td id="modalStudentPhone">-</td></tr>
                                    <tr><td><strong>Email:</strong></td><td id="modalStudentEmail">-</td></tr>
                                </table>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-success">💰 Información de Pagos</h6>
                                <table class="table table-dark table-sm">
                                    <tr><td><strong>Fecha Inscripción:</strong></td><td id="modalStudentEnrollment">-</td></tr>
                                    <tr><td><strong>Último Pago:</strong></td><td id="modalStudentLastPayment">-</td></tr>
                                    <tr><td><strong>Próximo Vence:</strong></td><td id="modalStudentNextDue">-</td></tr>
                                    <tr><td><strong>Mensualidad:</strong></td><td id="modalStudentMonthlyFee">-</td></tr>
                                    <tr><td><strong>Forma de Pago:</strong></td><td id="modalStudentPaymentMethod">-</td></tr>
                                    <tr><td><strong>Total Pagado:</strong></td><td id="modalStudentTotalPaid">-</td></tr>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Payment History Chart -->
                        <div class="mt-3">
                            <h6 class="text-warning">📊 Historial de Pagos (Últimos 12 meses)</h6>
                            <canvas id="paymentHistoryChart" width="400" height="200"></canvas>
                            <div id="chartLoadingState" class="text-center py-3" style="display: none;">
                                <i class="fas fa-spinner fa-spin"></i> Cargando historial...
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-warning" onclick="markPaymentReceived()">
                            <i class="fas fa-money-bill me-1"></i>Registrar Pago
                        </button>
                        <button type="button" class="btn btn-info" onclick="sendPaymentReminder()">
                            <i class="fas fa-bell me-1"></i>Enviar Recordatorio
                        </button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-1"></i>Cerrar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========================================= -->
        <!-- MODAL EDICIÓN DE ALUMNO -->
        <!-- ========================================= -->
        <div class="modal fade" id="editStudentModal" tabindex="-1">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-user-edit me-2"></i>
                            Editar Información del Alumno
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="editStudentForm">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="editStudentName" class="form-label">
                                        <i class="fas fa-user me-1"></i>Nombre Completo
                                    </label>
                                    <input type="text" class="form-control" id="editStudentName" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="editStudentAge" class="form-label">
                                        <i class="fas fa-birthday-cake me-1"></i>Edad
                                    </label>
                                    <input type="number" class="form-control" id="editStudentAge" min="1" max="100" required>
                                </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="editStudentPhone" class="form-label">
                                            <i class="fas fa-mobile-alt me-1"></i>Celular / WhatsApp
                                        </label>
                                        <input type="tel" class="form-control" id="editStudentPhone" placeholder="Ej: 5551234567">
                                        <small class="form-text">Incluir número de WhatsApp si aplica</small>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="editStudentEmail" class="form-label">
                                            <i class="fas fa-envelope me-1"></i>Email
                                        </label>
                                        <input type="email" class="form-control" id="editStudentEmail" placeholder="ejemplo@correo.com">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="editStudentEnrollmentDate" class="form-label">
                                        <i class="fas fa-calendar me-1"></i>Fecha de Inscripción
                                    </label>
                                    <input type="date" class="form-control" id="editStudentEnrollmentDate" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="editStudentInstrument" class="form-label">
                                        <i class="fas fa-music me-1"></i>Instrumento/Clase
                                    </label>
                                    <select class="form-select" id="editStudentInstrument" required>
                                        <option value="">Selecciona instrumento</option>
                                        <option value="Guitarra">🎸 Guitarra</option>
                                        <option value="Teclado">🎹 Teclado</option>
                                        <option value="Batería">🥁 Batería</option>
                                        <option value="Bajo">🎸 Bajo</option>
                                        <option value="Canto">🎤 Canto</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="editStudentTeacher" class="form-label">
                                        <i class="fas fa-chalkboard-teacher me-1"></i>Maestro
                                    </label>
                                    <select class="form-select" id="editStudentTeacher" required>
                                        <option value="">Selecciona maestro</option>
                                        <option value="1">🎸 Hugo Vazquez</option>
                                        <option value="2">🥁 Julio Olvera</option>
                                        <option value="3">🥁 Demian Andrade</option>
                                        <option value="4">🎸 Irwin Hernandez</option>
                                        <option value="5">🎤 Nahomy Perez</option>
                                        <option value="6">🎸 Luis Blanquet</option>
                                        <option value="7">🎹 Manuel Reyes</option>
                                        <option value="8">🎹 Harim Lopez</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="editStudentSchedule" class="form-label">
                                        <i class="fas fa-clock me-1"></i>Horario
                                    </label>
                                    <input type="text" class="form-control" id="editStudentSchedule" placeholder="Ej: Lunes 4:00-5:00 PM">
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label for="editStudentStatus" class="form-label">
                                        <i class="fas fa-toggle-on me-1"></i>Estatus
                                    </label>
                                    <select class="form-select" id="editStudentStatus" required>
                                        <option value="Activo">✅ Activo</option>
                                        <option value="Baja">❌ Baja</option>
                                    </select>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="editStudentPromotion" class="form-label">
                                        <i class="fas fa-percentage me-1"></i>Promoción
                                    </label>
                                    <input type="text" class="form-control" id="editStudentPromotion" placeholder="Ej: 10% descuento">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="editStudentMonthlyFee" class="form-label">
                                        <i class="fas fa-dollar-sign me-1"></i>Mensualidad
                                    </label>
                                    <input type="number" class="form-control" id="editStudentMonthlyFee" step="0.01" required>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label for="editStudentPaymentMethod" class="form-label">
                                        <i class="fas fa-credit-card me-1"></i>Forma de Pago
                                    </label>
                                    <select class="form-select" id="editStudentPaymentMethod" required>
                                        <option value="">Selecciona forma de pago</option>
                                        <option value="Efectivo">💵 Efectivo</option>
                                        <option value="Transferencia">🏦 Transferencia</option>
                                        <option value="TPV">📱 Terminal TPV</option>
                                    </select>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="editStudentDomiciled" class="form-label">
                                        <i class="fas fa-home me-1"></i>¿Domiciliado?
                                    </label>
                                    <select class="form-select" id="editStudentDomiciled" onchange="toggleDomiciliadoName()">
                                        <option value="No">❌ No</option>
                                        <option value="Si">✅ Sí</option>
                                    </select>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="editStudentDomiciliedName" class="form-label">
                                        <i class="fas fa-user-tag me-1"></i>Nombre Domiciliado
                                    </label>
                                    <input type="text" class="form-control" id="editStudentDomiciliedName" placeholder="Nombre para domiciliación" disabled>
                                </div>
                            </div>
                            
                            <input type="hidden" id="editStudentId" value="">
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-danger me-auto" onclick="deleteStudent()" title="Solo administradores">
                            <i class="fas fa-trash me-1"></i>Eliminar
                        </button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-1"></i>Cancelar
                        </button>
                        <button type="button" class="btn btn-primary" onclick="saveStudentChanges()">
                            <i class="fas fa-save me-1"></i>Guardar Cambios
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========================================= -->
        <!-- MODAL NUEVO ALUMNO -->
        <!-- ========================================= -->
        <div class="modal fade" id="addStudentModal" tabindex="-1">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-user-plus me-2"></i>
                            Registrar Nuevo Alumno
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="addStudentForm">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="newStudentName" class="form-label">
                                        <i class="fas fa-user me-1"></i>Nombre Completo *
                                    </label>
                                    <input type="text" class="form-control" id="newStudentName" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="newStudentAge" class="form-label">
                                        <i class="fas fa-birthday-cake me-1"></i>Edad *
                                    </label>
                                    <input type="number" class="form-control" id="newStudentAge" min="1" max="100" required>
                                </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="newStudentPhone" class="form-label">
                                            <i class="fas fa-mobile-alt me-1"></i>Celular / WhatsApp
                                        </label>
                                        <input type="tel" class="form-control" id="newStudentPhone" placeholder="Ej: 5551234567">
                                        <small class="form-text">Incluir número de WhatsApp si aplica</small>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="newStudentEmail" class="form-label">
                                            <i class="fas fa-envelope me-1"></i>Email
                                        </label>
                                        <input type="email" class="form-control" id="newStudentEmail" placeholder="ejemplo@correo.com">
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="newStudentEnrollmentDate" class="form-label">
                                        <i class="fas fa-calendar me-1"></i>Fecha de Inscripción *
                                    </label>
                                    <input type="date" class="form-control" id="newStudentEnrollmentDate" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="newStudentInstrument" class="form-label">
                                        <i class="fas fa-music me-1"></i>Instrumento/Clase *
                                    </label>
                                    <select class="form-select" id="newStudentInstrument" required>
                                        <option value="">Selecciona instrumento</option>
                                        <option value="Guitarra">🎸 Guitarra</option>
                                        <option value="Teclado">🎹 Teclado</option>
                                        <option value="Batería">🥁 Batería</option>
                                        <option value="Bajo">🎸 Bajo</option>
                                        <option value="Canto">🎤 Canto</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label for="newStudentMonthlyFee" class="form-label">
                                        <i class="fas fa-dollar-sign me-1"></i>Mensualidad *
                                    </label>
                                    <input type="number" class="form-control" id="newStudentMonthlyFee" step="0.01" value="1200" required>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="newStudentPaymentMethod" class="form-label">
                                        <i class="fas fa-credit-card me-1"></i>Forma de Pago *
                                    </label>
                                    <select class="form-select" id="newStudentPaymentMethod" required>
                                        <option value="Efectivo">💵 Efectivo</option>
                                        <option value="Transferencia">🏦 Transferencia</option>
                                        <option value="TPV">📱 Terminal TPV</option>
                                    </select>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="newStudentTeacher" class="form-label">
                                        <i class="fas fa-chalkboard-teacher me-1"></i>Maestro
                                    </label>
                                    <select class="form-select" id="newStudentTeacher">
                                        <option value="">Sin asignar</option>
                                        <option value="1">🎸 Hugo Vazquez</option>
                                        <option value="2">🥁 Julio Olvera</option>
                                        <option value="3">🥁 Demian Andrade</option>
                                        <option value="4">🎸 Irwin Hernandez</option>
                                        <option value="5">🎤 Nahomy Perez</option>
                                        <option value="6">🎸 Luis Blanquet</option>
                                        <option value="7">🎹 Manuel Reyes</option>
                                        <option value="8">🎹 Harim Lopez</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="newStudentDomiciled" class="form-label">
                                        <i class="fas fa-home me-1"></i>¿Domiciliado?
                                    </label>
                                    <select class="form-select" id="newStudentDomiciled" onchange="toggleNewStudentDomiciliadoName()">
                                        <option value="No">❌ No</option>
                                        <option value="Si">✅ Sí</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="newStudentDomiciliedName" class="form-label">
                                        <i class="fas fa-user-tag me-1"></i>Nombre Domiciliado
                                    </label>
                                    <input type="text" class="form-control" id="newStudentDomiciliedName" placeholder="Nombre para domiciliación" disabled>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-1"></i>Cancelar
                        </button>
                        <button type="button" class="btn btn-success" onclick="saveNewStudent()">
                            <i class="fas fa-save me-1"></i>Registrar Alumno
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Recent Transactions -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="text-white mb-0">
                    <i class="fas fa-history me-2"></i>Transacciones Recientes
                </h5>
                <div>
                    <button class="btn btn-outline-primary btn-sm me-2" onclick="refreshTransactions()">
                        <i class="fas fa-sync-alt me-1"></i>Actualizar
                    </button>
                    <button class="btn btn-primary btn-sm" onclick="showAddTransactionModal()">
                        <i class="fas fa-plus me-1"></i>Nueva
                    </button>
                </div>
            </div>
            <div class="card-body">
                <!-- Loading State -->
                <div class="loading-spinner" id="transactionsLoading">
                    <i class="fas fa-spinner fa-spin fa-2x text-primary"></i>
                    <p class="mt-2">Cargando transacciones...</p>
                </div>

                <!-- Empty State -->
                <div class="empty-state" id="emptyState" style="display: none;">
                    <i class="fas fa-inbox fa-3x mb-3"></i>
                    <p>No hay transacciones registradas</p>
                    <button class="btn btn-outline-primary" onclick="showAddTransactionModal()">
                        <i class="fas fa-plus me-2"></i>Agregar Primera Transacción
                    </button>
                </div>

                <!-- Transactions Table -->
                <div class="table-responsive" id="transactionsTable" style="display: none;">
                    <table class="table table-dark table-hover">
                        <thead>
                            <tr>
                                <th><i class="fas fa-calendar-alt me-1"></i>Fecha</th>
                                <th><i class="fas fa-receipt me-1"></i>Concepto</th>
                                <th><i class="fas fa-user me-1"></i>Socio</th>
                                <th><i class="fas fa-building me-1"></i>Empresa</th>
                                <th><i class="fas fa-tags me-1"></i>Tipo</th>
                                <th><i class="fas fa-dollar-sign me-1"></i>Total</th>
                                <th><i class="fas fa-cogs me-1"></i>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="transactionsBody">
                            <!-- Se llenarán dinámicamente -->
                        </tbody>
                    </table>
                    
                    <!-- Pagination -->
                    <nav aria-label="Paginación de transacciones" class="mt-3">
                        <ul class="pagination justify-content-center" id="pagination">
                            <!-- Se generará dinámicamente -->
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>

    <!-- 🆕 MODAL NUEVA TRANSACCIÓN -->
    <div class="modal fade" id="addTransactionModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-plus me-2"></i>Nueva Transacción
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addTransactionForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="transactionDate" class="form-label">
                                    <i class="fas fa-calendar me-1"></i>Fecha
                                </label>
                                <input type="date" class="form-control" id="transactionDate" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="transactionType" class="form-label">
                                    <i class="fas fa-tags me-1"></i>Tipo
                                </label>
                                <select class="form-select" id="transactionType" required>
                                    <option value="">Selecciona el tipo</option>
                                    <option value="I">💰 Ingreso</option>
                                    <option value="G">💸 Gasto</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="transactionConcept" class="form-label">
                                <i class="fas fa-receipt me-1"></i>Concepto
                            </label>
                            <input type="text" class="form-control" id="transactionConcept" 
                                   placeholder="Descripción de la transacción" required>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="transactionCompany" class="form-label">
                                    <i class="fas fa-building me-1"></i>Empresa
                                </label>
                                <select class="form-select" id="transactionCompany" required>
                                    <option value="">Cargando empresas...</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="transactionPayment" class="form-label">
                                    <i class="fas fa-credit-card me-1"></i>Forma de Pago
                                </label>
                                <select class="form-select" id="transactionPayment" required>
                                    <option value="">Selecciona forma de pago</option>
                                    <option value="Efectivo">💵 Efectivo</option>
                                    <option value="TDC">💳 Tarjeta de Crédito</option>
                                    <option value="Transferencia">🏦 Transferencia</option>
                                    <option value="TPV">📱 Terminal TPV</option>
                                    <option value="Cheque">📝 Cheque</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="transactionQuantity" class="form-label">
                                    <i class="fas fa-hashtag me-1"></i>Cantidad
                                </label>
                                <input type="number" class="form-control" id="transactionQuantity" 
                                       value="1" min="0.01" step="0.01" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="transactionPrice" class="form-label">
                                    <i class="fas fa-dollar-sign me-1"></i>Precio Unitario
                                </label>
                                <input type="number" class="form-control" id="transactionPrice" 
                                       min="0.01" step="0.01" placeholder="0.00" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="transactionTotal" class="form-label">
                                    <i class="fas fa-calculator me-1"></i>Total
                                </label>
                                <input type="text" class="form-control" id="transactionTotal" 
                                       placeholder="$0.00" readonly style="background-color: rgba(255,255,255,0.05);">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Cancelar
                    </button>
                    <button type="button" class="btn btn-primary" onclick="submitTransaction()">
                        <i class="fas fa-save me-1"></i>Guardar Transacción
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Chart.js para gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // 🌐 Variables globales
        let currentUser = null;
        let currentPage = 1;

        // 🎓 Variables para gestión de alumnos
        let studentsData = [];                    // Datos de la página actual desde el servidor
        let currentStudentsPage = 1;              // Página actual
        let studentsPerPage = 10;                 // Registros por página
        let totalStudentsPages = 1;               // Total de páginas desde el servidor
        let totalStudentsRecords = 0;             // Total de registros desde el servidor

        // Variables para filtros actuales
        let currentStudentFilters = {
            teacherFilter: '',
            statusFilter: '',
            instrumentFilter: '',
            paymentFilter: ''
        };

        console.log('🎓 Variables globales de alumnos inicializadas');

        let classDistributionData = [];

        const transactionsPerPage = 10;
        // Añadir: estado para edición desde dashboard y cache temporal de transacciones
        window.editingTransactionId = null;
        window.recentTransactionsCache = [];


        // ✅ CORREGIDO: Asegurar que el modal esté disponible
        let addTransactionModalInstance = null;

        // 🚀 Inicialización al cargar la página
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🚀 Inicializando dashboard...');
            
            try {
                // Verificar sesión y obtener usuario
                await loadCurrentUser();
                
                // Cargar datos del dashboard
                await loadDashboardData();
                
                // Cargar transacciones recientes
                await loadRecentTransactions();
                
                // Establecer fecha actual
                updateCurrentDate();

                // ✅ Cargar alertas automáticamente
                setTimeout(async () => {
                    await refreshPaymentAlerts();
                }, 1000);

                // Cargar alertas automáticamente
                await refreshPaymentAlerts();
                
                // Cargar empresas para el modal
                await loadCompaniesForModal();
 
                // ✅ CORREGIDO: Inicializar modal correctamente
                const modalElement = document.getElementById('addTransactionModal');
                if (modalElement) {
                    addTransactionModalInstance = new bootstrap.Modal(modalElement);
                    console.log('✅ Modal inicializado correctamente');
                }
                
                // ✅ CORREGIDO: Configurar listeners de cálculo
                setupCalculationListeners();
                
                // Configurar fecha por defecto en modal
                const today = new Date();
                const todayString = today.toISOString().split('T')[0];
                document.getElementById('transactionDate').value = todayString;
                
                console.log('✅ Dashboard cargado exitosamente');
                
            } catch (error) {
                console.error('❌ Error cargando dashboard:', error);
                showAlert('danger', 'Error cargando el dashboard. Redirigiendo al login...');
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 2000);
            }
        });

        // ✅ CORREGIDO: Configurar listeners de cálculo automático
        function setupCalculationListeners() {
            const quantity = document.getElementById('transactionQuantity');
            const price = document.getElementById('transactionPrice');
            const total = document.getElementById('transactionTotal');
            
            function updateTotal() {
                const qty = parseFloat(quantity.value) || 0;
                const prc = parseFloat(price.value) || 0;
                const totalAmount = qty * prc;
                total.value = formatCurrency(totalAmount);
            }
            
            if (quantity && price && total) {
                quantity.addEventListener('input', updateTotal);
                price.addEventListener('input', updateTotal);
                console.log('✅ Listeners de cálculo configurados');
            }
        }

        // 👤 Cargar usuario actual
        async function loadCurrentUser() {
            try {
                console.log('👤 Cargando usuario actual...');
                
                const response = await fetch('/api/user');
                const data = await response.json();
                
                if (data.success) {
                    currentUser = data.user;
                    document.getElementById('userName').textContent = currentUser.nombre;
                    document.getElementById('userNameDisplay').textContent = currentUser.nombre;
                    document.getElementById('userCompany').textContent = currentUser.empresa;
                    
                    console.log('✅ Usuario cargado:', currentUser.nombre);
                } else {
                    throw new Error('No hay sesión activa');
                }
                
            } catch (error) {
                console.error('❌ Error cargando usuario:', error);
                throw error;
            }
        }


        // 🎨 Renderizar transacciones en la tabla
        function renderTransactions(transactions) {
            const tbody = document.getElementById('transactionsBody');
            tbody.innerHTML = '';
            
            transactions.forEach(transaction => {
                const row = document.createElement('tr');
                row.className = 'transaction-row';
                
                const tipoLabel = transaction.tipo === 'I' ? 'Ingreso' : 'Gasto';
                const tipoBadge = transaction.tipo === 'I' ? 'badge-success' : 'badge-danger';
                const tipoIcon = transaction.tipo === 'I' ? 'fas fa-arrow-up' : 'fas fa-arrow-down';
                
                row.innerHTML = `
                    <td>${formatDate(transaction.fecha)}</td>
                    <td>${transaction.concepto}</td>
                    <td>${transaction.socio}</td>
                    <td>${transaction.nombre_empresa || 'N/A'}</td>
                    <td><span class="badge ${tipoBadge}"><i class="${tipoIcon} me-1"></i>${tipoLabel}</span></td>
                    <td class="${transaction.tipo === 'I' ? 'text-success' : 'text-danger'}">${formatCurrency(transaction.total)}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="editTransactionFromDashboard(${transaction.id})" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteTransaction(${transaction.id})" title="Eliminar">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        // ✅ FUNCIÓN CORREGIDA: Usar patrón de gastos.html (funcional)
        async function editTransactionFromDashboard(transactionId) {
            console.log(`✏️ Editando transacción ${transactionId} desde dashboard`);

            try {
                // 1) Buscar en cache local (patrón gastos.html exitoso)
                const transaction = (window.recentTransactionsCache || []).find(t => String(t.id) === String(transactionId));
                
                if (!transaction) {
                    showAlert('warning', 'Transacción no encontrada. Actualiza la lista y vuelve a intentar.');
                    return;
                }

                // 2) Marcar modo edición (patrón gastos.html)
                window.editingTransactionId = transaction.id;

                // 3) Llenar modal con datos (patrón gastos.html)
                try {
                    // Fecha: asegurar formato YYYY-MM-DD
                    const fecha = new Date(transaction.fecha);
                    const fechaString = isNaN(fecha.getTime()) 
                        ? new Date().toISOString().split('T')[0]
                        : fecha.toISOString().split('T')[0];
                    document.getElementById('transactionDate').value = fechaString;
                } catch (e) {
                    document.getElementById('transactionDate').value = new Date().toISOString().split('T')[0];
                }

                document.getElementById('transactionConcept').value = transaction.concepto || '';
                document.getElementById('transactionCompany').value = transaction.empresa_id || '';
                document.getElementById('transactionPayment').value = transaction.forma_pago || '';
                document.getElementById('transactionQuantity').value = transaction.cantidad || 1;
                document.getElementById('transactionPrice').value = transaction.precio_unitario || '';
                document.getElementById('transactionType').value = transaction.tipo || 'I';

                // 4) Calcular total automáticamente
                const qty = parseFloat(document.getElementById('transactionQuantity').value || 1);
                const price = parseFloat(document.getElementById('transactionPrice').value || 0);
                document.getElementById('transactionTotal').value = formatCurrency(qty * price);

                // 5) Mostrar modal
                if (!addTransactionModalInstance) {
                    addTransactionModalInstance = new bootstrap.Modal(document.getElementById('addTransactionModal'));
                }
                addTransactionModalInstance.show();

                // 6) Cambiar texto del botón
                const saveBtn = document.querySelector('#addTransactionModal .modal-footer .btn-primary');
                if (saveBtn) saveBtn.innerHTML = '<i class="fas fa-save me-1"></i>Actualizar Transacción';

                console.log('✅ Modal prellenado exitosamente para edición');
                
            } catch (error) {
                console.error('❌ Error en editTransactionFromDashboard:', error);
                showAlert('danger', 'Error cargando datos para editar la transacción');
            }
        }


        // 📄 Renderizar paginación
        function renderPagination(pagination) {
            const paginationElement = document.getElementById('pagination');
            paginationElement.innerHTML = '';
            
            if (!pagination.totalPages || pagination.totalPages <= 1) return;
            
            // Botón anterior
            if (pagination.currentPage > 1) {
                paginationElement.innerHTML += `
                    <li class="page-item">
                        <a class="page-link" href="#" onclick="event.preventDefault(); loadRecentTransactions(${pagination.currentPage - 1})">Anterior</a>
                    </li>
                `;
            }
            
            // Páginas
            for (let i = 1; i <= pagination.totalPages; i++) {
                const isActive = i === pagination.currentPage ? 'active' : '';
                paginationElement.innerHTML += `
                    <li class="page-item ${isActive}">
                        <a class="page-link" href="#" onclick="event.preventDefault(); loadRecentTransactions(${i})">${i}</a>
                    </li>
                `;
            }
            
            // Botón siguiente
            if (pagination.currentPage < pagination.totalPages) {
                paginationElement.innerHTML += `
                    <li class="page-item">
                        <a class="page-link" href="#" onclick="event.preventDefault(); loadRecentTransactions(${pagination.currentPage + 1})">Siguiente</a>
                    </li>
                `;
            }
        }

        // 🏢 Cargar empresas para el modal
        async function loadCompaniesForModal() {
            try {
                const response = await fetch('/api/empresas');
                const data = await response.json();
                
                if (data.success) {
                    const select = document.getElementById('transactionCompany');
                    select.innerHTML = '<option value="">Selecciona empresa</option>';
                    
                    data.data.forEach(empresa => {
                        select.innerHTML += `<option value="${empresa.id}">${empresa.nombre}</option>`;
                    });
                    
                    console.log('✅ Empresas cargadas en modal');
                } else {
                    console.warn('⚠️ No se pudieron cargar empresas');
                }
            } catch (error) {
                console.error('❌ Error cargando empresas:', error);
            }
        }

        // ✅ CORREGIDO: Mostrar modal nueva transacción
        function showAddTransactionModal() {
            console.log('🆕 Abriendo modal nueva transacción.');

            try {
                // Reset estado de edición (abrimos como NUEVA transacción)
                window.editingTransactionId = null;

                // ✅ Cambiar texto del botón a "Guardar" para nueva transacción
                const saveBtn = document.querySelector('#addTransactionModal .modal-footer .btn-primary');
                if (saveBtn) saveBtn.innerHTML = '<i class="fas fa-save me-1"></i>Guardar Transacción';

                // Limpiar formulario
                document.getElementById('addTransactionForm').reset();

                // Establecer fecha actual
                const today = new Date();
                const todayString = today.toISOString().split('T')[0];
                document.getElementById('transactionDate').value = todayString;

                // Limpiar total y precio
                document.getElementById('transactionTotal').value = '$0.00';
                document.getElementById('transactionPrice').value = '';

                // Mostrar modal
                if (addTransactionModalInstance) {
                    addTransactionModalInstance.show();
                    console.log('✅ Modal abierto correctamente');
                } else {
                    const modalElement = document.getElementById('addTransactionModal');
                    if (modalElement) {
                        addTransactionModalInstance = new bootstrap.Modal(modalElement);
                        addTransactionModalInstance.show();
                        console.log('✅ Modal creado y abierto');
                    } else {
                        throw new Error('Modal element not found');
                    }
                }

            } catch (error) {
                console.error('❌ Error abriendo modal:', error);
                showAlert('danger', 'Error abriendo el formulario de nueva transacción');
            }
        }


        // ✅ CORREGIDO: Enviar transacción
        async function submitTransaction() {
            console.log('💾 Enviando transacción...');
            
            try {
                const form = document.getElementById('addTransactionForm');
                
                // Validar formulario
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }
                
                // Recoger datos (patrón gastos.html)
                const transactionData = {
                    fecha: document.getElementById('transactionDate').value,
                    concepto: document.getElementById('transactionConcept').value,
                    empresa_id: parseInt(document.getElementById('transactionCompany').value),
                    forma_pago: document.getElementById('transactionPayment').value,
                    cantidad: parseFloat(document.getElementById('transactionQuantity').value),
                    precio_unitario: parseFloat(document.getElementById('transactionPrice').value),
                    tipo: document.getElementById('transactionType').value
                };
                
                // Determinar modo (patrón gastos.html)
                const url = window.editingTransactionId 
                    ? `/api/transacciones/${window.editingTransactionId}`
                    : '/api/transacciones';
                const method = window.editingTransactionId ? 'PUT' : 'POST';
                
                console.log(`📤 ${window.editingTransactionId ? 'Actualizando' : 'Creando'} transacción:`, transactionData);
                
                // Enviar al servidor (patrón gastos.html)
                const response = await fetch(url, {
                    method: method,
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(transactionData)
                });
                
                const result = await response.json();
                console.log('📥 Respuesta del servidor:', result);

                if (!result.success && result.message === 'Transacción no encontrada' && currentUser && currentUser.rol === 'admin') {
                    console.log('🔧 Modo admin: intentando operación sin verificar propietario...');
                    showAlert('info', 'Como administrador, tienes permisos especiales pero esta transacción requiere verificación manual');
                    return;
                }
                
                if (result.success) {
                    // Cerrar modal
                    if (addTransactionModalInstance) {
                        addTransactionModalInstance.hide();
                    }
                    
                    // Limpiar estado de edición (patrón gastos.html)
                    window.editingTransactionId = null;
                    
                    // Mostrar éxito
                    const tipoTexto = transactionData.tipo === 'I' ? 'Ingreso' : 'Gasto';
                    const actionText = method === 'PUT' ? 'actualizado' : 'registrado';
                    showAlert('success', `${tipoTexto} ${actionText} exitosamente: ${transactionData.concepto}`);
                    
                    // Recargar datos
                    console.log('🔄 Recargando dashboard...');
                    await loadDashboardData();
                    await loadRecentTransactions();
                    
                } else {
                    throw new Error(result.message || 'Error procesando transacción');
                }
                
            } catch (error) {
                console.error('❌ Error procesando transacción:', error);
                showAlert('danger', 'Error procesando la transacción: ' + error.message);
            }
        }

        // ✅ CORREGIDO: Cerrar sesión
        async function logout() {
            if (confirm('¿Está seguro que desea cerrar sesión?')) {
                try {
                    console.log('🚪 Cerrando sesión...');
                    
                    const response = await fetch('/api/logout', { 
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        }
                    });
                    
                    console.log('📤 Respuesta logout:', response.status);
                    
                    // Intentar obtener respuesta JSON
                    let data = null;
                    try {
                        data = await response.json();
                    } catch (parseError) {
                        console.log('⚠️ No se pudo parsear respuesta JSON');
                    }
                    
                    if (response.ok || response.status === 200) {
                        console.log('✅ Logout exitoso');
                        localStorage.removeItem('rememberedEmail');
                        window.location.href = 'login.html';
                    } else {
                        throw new Error('Error en logout del servidor');
                    }
                    
                } catch (error) {
                    console.error('❌ Error en logout:', error);
                    // Forzar redirección incluso si hay error
                    showAlert('warning', 'Cerrando sesión...');
                    localStorage.removeItem('rememberedEmail');
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 1000);
                }
            }
        }

        // ✅ CORREGIDO: Mostrar mensaje "Próximamente"
        function showComingSoon(feature) {
            console.log(`🚧 Función ${feature} próximamente...`);
            showAlert('info', `📋 ${feature} estará disponible en la próxima fase del desarrollo`);
        }

        // 🔄 Actualizar transacciones
        function refreshTransactions() {
            console.log('🔄 Actualizando transacciones...');
            loadRecentTransactions(currentPage);
        }

        async function deleteTransaction(id) {
            console.log(`🗑️ Eliminando transacción ${id}...`);
            
            if (confirm('¿Está seguro de eliminar esta transacción?')) {
                try {
                    console.log(`🔥 Enviando DELETE para transacción ${id}...`);
                    
                    const response = await fetch(`/api/transacciones/${id}`, {
                        method: 'DELETE',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        }
                    });
                    
                    const data = await response.json();
                    console.log('📥 Respuesta DELETE:', data);

                    // ✅ Manejar error de permisos específicamente
                    if (!result.success && result.message === 'Transacción no encontrada' && currentUser && currentUser.rol === 'admin') {
                        console.log('🔧 Modo admin: intentando operación sin verificar propietario...');
                        showAlert('info', 'Como administrador, tienes permisos especiales pero esta transacción requiere verificación manual');
                        return;
                    }
                    
                } catch (error) {
                    console.error('❌ Error eliminando transacción:', error);
                    showAlert('danger', 'Error eliminando la transacción: ' + error.message);
                }
            }
        }

        // 🛠️ Funciones de utilidad
        function formatCurrency(amount) {
            if (amount == null || isNaN(amount)) return '$0.00';
            return new Intl.NumberFormat('es-MX', {
                style: 'currency',
                currency: 'MXN'
            }).format(amount);
        }

        function formatDate(dateString) {
            if (!dateString) return 'No disponible';
            
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return 'Fecha inválida';
                
                return date.toLocaleDateString('es-ES', {
                    day: '2-digit',
                    month: '2-digit', 
                    year: 'numeric'
                });
            } catch (error) {
                return 'Error en fecha';
            }
        }

        function updateCurrentDate() {
            const now = new Date();
            document.getElementById('currentDate').textContent = now.toLocaleDateString('es-MX', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        function showAlert(type, message) {
            const alertContainer = document.getElementById('alertContainer');
            const alertId = 'alert-' + Date.now();
            
            const alert = document.createElement('div');
            alert.id = alertId;
            alert.className = `alert alert-${type} alert-dismissible fade show`;
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            alertContainer.appendChild(alert);
            
            // Auto-dismiss después de 5 segundos
            setTimeout(() => {
                const alertElement = document.getElementById(alertId);
                if (alertElement && alertElement.parentNode) {
                    alertElement.remove();
                }
            }, 5000);
        }

        function showNoDataStats() {
            document.getElementById('totalIngresos').textContent = '$0.00';
            document.getElementById('totalGastos').textContent = '$0.00';
            document.getElementById('balanceTotal').textContent = '$0.00';
            document.getElementById('esteMes').textContent = '$0.00';
        }

        // 🔧 Log para debugging
        console.log('✅ Script dashboard cargado correctamente');
                
        // 🏢 Variables para filtro de empresa
        let currentCompanyFilter = '';
        let rockstarStudentsData = [];

        // 🔄 Manejar cambio de empresa
        async function handleCompanyChange() {
            const companySelect = document.getElementById('companyFilter');
            const selectedCompany = companySelect.value;
            currentCompanyFilter = selectedCompany;
            
            console.log(`🏢 Filtro de empresa cambiado a: ${selectedCompany || 'Todas'}`);
            
            try {
                // Recargar datos con filtro
                await loadDashboardData();
                await loadRecentTransactions(1);
                await loadCompanyStats(selectedCompany);
                
                // Mostrar/ocultar widgets específicos de RockstarSkull
                const rockstarWidgets = document.getElementById('rockstarSkullWidgets');
                if (selectedCompany === '1') { // RockstarSkull
                    rockstarWidgets.style.display = 'block';
                    await loadRockstarSkullData();
                    showRockstarSkullIndicators();
                    loadStudentsList(); // ← ESTA LÍNEA DEBE EXISTIR
                }
                
            } catch (error) {
                console.error('❌ Error cambiando filtro de empresa:', error);
                showAlert('danger', 'Error aplicando filtro de empresa');
            }
        }

        // 📊 Cargar estadísticas específicas de empresa
        async function loadCompanyStats(companyId) {
            try {
                let queryParam = companyId ? `?empresa_id=${companyId}` : '';
                const response = await fetch(`/api/transacciones/resumen${queryParam}`);
                const data = await response.json();
                
                if (data.success) {
                    const resumen = data.data;
                    
                    // Actualizar stats del selector
                    document.getElementById('companyTransactions').textContent = resumen.total_transacciones || 0;
                    document.getElementById('companyIncome').textContent = formatCurrency(resumen.ingresos || 0);
                    document.getElementById('companyExpenses').textContent = formatCurrency(resumen.gastos || 0);
                    document.getElementById('companyBalance').textContent = formatCurrency(resumen.balance || 0);
                    
                    // Cambiar color del balance
                    const balanceElement = document.getElementById('companyBalance');
                    if ((resumen.balance || 0) >= 0) {
                        balanceElement.className = 'stat-number text-success';
                    } else {
                        balanceElement.className = 'stat-number text-danger';
                    }
                }
            } catch (error) {
                console.error('❌ Error cargando stats de empresa:', error);
            }
        }

        // 🎯 FUNCIÓN ACTUALIZADA: showRockstarSkullIndicators SIN HARDCODE
        function showRockstarSkullIndicators() {
            console.log('🎸 Mostrando indicadores RockstarSkull...');
            
            // Mostrar los indicadores específicos
            document.getElementById('groupClassesIndicator').style.display = 'block'; 
            document.getElementById('individualClassesIndicator').style.display = 'block'; 
            document.getElementById('currentStudentsIndicator').style.display = 'block';
            document.getElementById('pendingStudentsIndicator').style.display = 'block';
            
            // ❌ ELIMINADO: Datos hardcodeados
            // Los valores ahora se cargan desde loadRockstarSkullData() con datos reales del API
            
            // ✅ Los datos se mostrarán una vez que loadRockstarSkullData() los cargue
            console.log('✅ Indicadores RockstarSkull mostrados (datos cargados desde API)');
        }

        // 🔄 Actualizar alertas de pagos
        async function refreshPaymentAlerts() {
            try {
                console.log('🔄 Actualizando alertas de pagos...');
                
                // Añadir empresa_id para respetar selector de empresa y filtrar alumnos en baja en frontend
                // Usar empresa seleccionada y evitar cache del navegador
                const empresaParam = currentCompanyFilter ? currentCompanyFilter : 1;
                const response = await fetch(`/api/alertas-pagos?empresa_id=${empresaParam}`, { cache: 'no-store' });
                const data = await response.json();
                
                if (data.success) {
                    // Asegurar arrays
                    let proximos_vencer = Array.isArray(data.data.proximos_vencer) ? data.data.proximos_vencer : [];
                    let vencidos = Array.isArray(data.data.vencidos) ? data.data.vencidos : [];

                    // Debug: inspeccionar la respuesta cruda (revisa console.log en DevTools)
                    console.log('📥 Respuesta alertas detallada:', { proximos_vencer, vencidos });

                    // Filtrar alumnos dados de baja (por si el backend los devuelve)
                    proximos_vencer = proximos_vencer.filter(a => String(a.estatus || '').toLowerCase() !== 'baja');
                    vencidos = vencidos.filter(a => String(a.estatus || '').toLowerCase() !== 'baja');

                    // Helper: calcular días entre dos fechas usando UTC midnight (evita off-by-one por zonas horarias)
                    function daysBetweenDates(toDate, fromDate = new Date()) {
                        const a = Date.UTC(toDate.getFullYear(), toDate.getMonth(), toDate.getDate());
                        const b = Date.UTC(fromDate.getFullYear(), fromDate.getMonth(), fromDate.getDate());
                        return Math.round((a - b) / (24 * 60 * 60 * 1000));
                    }

                    // =========================
                    // 1) Próximos a vencer (≤ 3 días antes de la fecha de corte)
                    // =========================
                    const proximosHTML = proximos_vencer.length > 0
                        ? proximos_vencer
                            .filter(alumno => {
                                if (String(alumno.estatus || '').toLowerCase() === 'baja') return false;

                                const fechaProxRaw = alumno.proximo_pago || alumno.next_payment_date || alumno.proximoPago || alumno.next_due;
                                let nextDate = fechaProxRaw ? new Date(fechaProxRaw) : null;

                                if (!nextDate && (alumno.fecha_inscripcion || alumno.fechaInscripcion)) {
                                    const stub = Object.assign({}, alumno);
                                    stub.fechaInscripcion = alumno.fechaInscripcion || alumno.fecha_inscripcion;
                                    nextDate = getNextPaymentDate(stub);
                                }

                                if (!(nextDate instanceof Date) || isNaN(nextDate)) return false;

                                const daysDiff = daysBetweenDates(nextDate, new Date());
                                return daysDiff >= 0 && daysDiff <= 3; // Solo mostrar si faltan ≤ 3 días
                            })
                            .map(alumno => {
                                const fechaProxRaw = alumno.proximo_pago || alumno.next_payment_date || alumno.proximoPago || alumno.next_due;
                                const nextDate = fechaProxRaw ? new Date(fechaProxRaw) : getNextPaymentDate(alumno);
                                const daysDiff = daysBetweenDates(nextDate, new Date());

                                const labelHtml = daysDiff === 0
                                    ? '<small class="text-warning">HOY</small>'
                                    : `<small class="text-info">en ${daysDiff} días</small>`;

                                return `
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <small><strong>${alumno.nombre}</strong> - ${alumno.clase || ''}</small>
                                        ${labelHtml}
                                    </div>
                                `;
                            }).join('')
                        : '<small class="text-muted">✅ No hay pagos próximos a vencer</small>';

                    // =========================
                    // 2) Pagos vencidos (> 5 días después de fecha de corte)
                    // =========================
                    const vencidosHTML = vencidos.length > 0
                        ? vencidos
                            .filter(alumno => {
                                if (String(alumno.estatus || '').toLowerCase() === 'baja') return false;

                                const fechaProxRaw = alumno.proximo_pago || alumno.next_payment_date || alumno.proximoPago || alumno.next_due;
                                let nextDate = fechaProxRaw ? new Date(fechaProxRaw) : null;

                                if (!nextDate && (alumno.fecha_inscripcion || alumno.fechaInscripcion)) {
                                    const stub = Object.assign({}, alumno);
                                    stub.fechaInscripcion = alumno.fechaInscripcion || alumno.fecha_inscripcion;
                                    nextDate = getNextPaymentDate(stub);
                                }

                                if (!(nextDate instanceof Date) || isNaN(nextDate)) return false;

                                const daysDiff = daysBetweenDates(new Date(), nextDate); // días desde corte hasta hoy
                                return daysDiff > 5; // Solo mostrar si ya pasaron más de 5 días después de corte
                            })
                            .map(alumno => {
                                const fechaProxRaw = alumno.proximo_pago || alumno.next_payment_date || alumno.proximoPago || alumno.next_due;
                                const nextDate = fechaProxRaw ? new Date(fechaProxRaw) : getNextPaymentDate(alumno);
                                const daysOverdue = daysBetweenDates(new Date(), nextDate);

                                return `
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <small><strong>${alumno.nombre}</strong> - ${alumno.clase || ''}</small>
                                        <small class="text-danger">🚨 ${daysOverdue} días</small>
                                    </div>
                                `;
                            }).join('')
                        : '<small class="text-muted">✅ No hay pagos vencidos</small>';

                    // Actualizar DOM
                    document.getElementById('upcomingPayments').innerHTML = proximosHTML;
                    document.getElementById('overduePayments').innerHTML = vencidosHTML;

                    showAlert('success', `✅ Alertas actualizadas: ${proximos_vencer.length + vencidos.length} alertas activas`);
                } else {
                    throw new Error(data.error || 'Error obteniendo alertas');
                }
                
            } catch (error) {
                console.error('❌ Error actualizando alertas:', error);
                showAlert('error', 'Error actualizando alertas de pagos');
                
                // Fallback a mensajes estáticos
                document.getElementById('upcomingPayments').innerHTML = 
                    '<small class="text-muted">⚠️ Error cargando alertas próximas</small>';
                document.getElementById('overduePayments').innerHTML = 
                    '<small class="text-muted">⚠️ Error cargando alertas vencidas</small>';
            }
        }

        // ====================================================
        // 🎓 FUNCIÓN PRINCIPAL: CARGAR ALUMNOS CON PAGINACIÓN DEL SERVIDOR
        // Patrón basado en gastos.html (100% funcional)
        // ====================================================
        async function loadStudentsList(page = 1) {
            try {
                console.log(`🎓 Cargando alumnos - Página ${page}...`);
                console.log('🔍 Filtros actuales:', currentStudentFilters);
                
                // Mostrar loading
                showStudentsLoadingState(true);
                
                // Construir URL con parámetros (igual que gastos.html)
                // Usar el filtro de empresa actual (si no existe, fallback a 1 para compatibilidad)
                const empresaIdParam = currentCompanyFilter ? currentCompanyFilter : 1;
                let url = `/api/alumnos?empresa_id=${empresaIdParam}&page=${page}&limit=${studentsPerPage}`;
                
                // Agregar filtros si existen
                if (currentStudentFilters.statusFilter) {
                    url += `&estatus=${currentStudentFilters.statusFilter}`;
                }
                if (currentStudentFilters.instrumentFilter) {
                    url += `&clase=${currentStudentFilters.instrumentFilter}`;
                }
                if (currentStudentFilters.teacherFilter) {
                    url += `&maestro_id=${currentStudentFilters.teacherFilter}`;
                }
                if (currentStudentFilters.paymentFilter) {
                    url += `&pago=${currentStudentFilters.paymentFilter}`;
                    console.log(`🔍 Aplicando filtro de pago: ${currentStudentFilters.paymentFilter}`);
                }
                
                console.log('📡 URL de solicitud:', url);
                console.log('🔍 Parámetros enviados:', { teacherFilter: currentStudentFilters.teacherFilter, paymentFilter: currentStudentFilters.paymentFilter });

                const response = await fetch(url);
                const result = await response.json();
                
                console.log('📥 Respuesta del servidor:', result);
                console.log('🔍 Filtro de pago aplicado:', currentStudentFilters.paymentFilter);
                console.log('📊 Registros recibidos:', result.data?.length || 0);
                console.log('📊 Total registros:', result.pagination?.total_records || 0);

                // Debugging específico para filtro de pagos
                if (currentStudentFilters.paymentFilter) {
                    console.log('🔍 DEBUGGING FILTRO PAGOS:', {
                        filtroAplicado: currentStudentFilters.paymentFilter,
                        urlEnviada: url,
                        alumnosRecibidos: result.data.length,
                        primerosAlumnos: result.data.slice(0, 3).map(s => ({
                            nombre: s.nombre,
                            estatus: s.estatus,
                            fechaInscripcion: s.fecha_inscripcion
                        }))
                    });
                    
                    // Verificar si el backend respeta el filtro
                    const estadosCalculados = result.data.map(student => ({
                        nombre: student.nombre,
                        estatusBackend: student.estatus,
                        estadoPagoCalculado: student.estatus === 'Baja' ? 'inactive' : 'current'
                    }));
                    
                    console.log('🎯 Estados calculados vs filtro:', {
                        filtroSolicitado: currentStudentFilters.paymentFilter,
                        estadosEncontrados: estadosCalculados
                    });
                }
                
                if (result.success && result.data) {
                    // Almacenar datos de la página actual
                    let rawData = result.data;

                    // Si el backend no aplicó el filtro de pagos, aplicarlo en frontend
                    if (currentStudentFilters.paymentFilter && rawData.length > 0) {
                        console.log('🔧 Aplicando filtro de pagos en frontend como respaldo');
                        
                        rawData = rawData.filter(student => {
                            const paymentStatus = getPaymentStatus(student);
                            const matches = paymentStatus === currentStudentFilters.paymentFilter;
                            
                            if (matches) {
                                console.log(`✅ ${student.nombre}: ${paymentStatus} coincide con filtro ${currentStudentFilters.paymentFilter}`);
                            }
                            
                            return matches;
                        });
                        
                        console.log(`🎯 Filtro frontend aplicado: ${rawData.length} de ${result.data.length} alumnos`);
                        
                        // Actualizar paginación manualmente
                        totalStudentsRecords = rawData.length;
                        totalStudentsPages = Math.ceil(totalStudentsRecords / studentsPerPage);
                        
                        // Aplicar paginación manual
                        const startIndex = (currentStudentsPage - 1) * studentsPerPage;
                        const endIndex = startIndex + studentsPerPage;
                        studentsData = rawData.slice(startIndex, endIndex);
                        
                        showAlert('info', `Filtro aplicado en frontend: ${rawData.length} alumnos encontrados`);
                    } else {
                        studentsData = rawData;
                    }

                    // Log final para debugging
                    console.log('📊 Datos finales después del procesamiento:', {
                        alumnosOriginales: result.data.length,
                        alumnosDespuesFiltro: studentsData.length,
                        filtroAplicado: currentStudentFilters.paymentFilter,
                        paginaActual: currentStudentsPage,
                        totalPaginas: totalStudentsPages,
                        totalRegistros: totalStudentsRecords
                    });
                    
                    // Actualizar información de paginación desde el servidor
                    if (result.pagination) {
                        currentStudentsPage = result.pagination.current_page || page;
                        totalStudentsPages = result.pagination.total_pages || 1;
                        totalStudentsRecords = result.pagination.total_records || 0;
                        
                        console.log('📊 Paginación actualizada:', {
                            currentStudentsPage,
                            totalStudentsPages,
                            totalStudentsRecords,
                            datosRecibidos: studentsData.length
                        });
                    }
                    
                    // Renderizar tabla y paginación
                    renderStudentsPage();
                    updateFilterSummary()
                    updateStudentsPaginationControls();
                    
                    // Validar si el filtro de pagos funcionó correctamente
                    if (currentStudentFilters.paymentFilter) {
                        const expectedFilter = currentStudentFilters.paymentFilter;
                        const actualStates = studentsData.map(s => s.estatus === 'Baja' ? 'inactive' : 'current');
                        const matchesFilter = actualStates.every(state => state === expectedFilter || expectedFilter === '');
                        
                        if (!matchesFilter && studentsData.length > 0) {
                            console.warn('⚠️ FILTRO DE PAGOS NO FUNCIONA - Backend no respeta el filtro');
                            showAlert('warning', `Filtro de pagos "${expectedFilter}" no aplicado correctamente por el backend`);
                        } else if (matchesFilter && studentsData.length === 0) {
                            console.log('✅ Filtro aplicado correctamente - sin resultados');
                        }
                    }

                    console.log(`✅ ${studentsData.length} alumnos cargados exitosamente`);
                    
                } else {
                    throw new Error(result.message || 'Error cargando alumnos');
                }
                
            } catch (error) {
                console.error('❌ Error cargando alumnos:', error);
                showStudentsEmptyState(`Error cargando alumnos: ${error.message}`);
            } finally {
                showStudentsLoadingState(false);
            }
        }

        function updateFilterSummary() {
            document.getElementById('filteredCount').textContent = totalStudentsRecords;
            document.getElementById('totalCount').textContent = totalStudentsRecords;
            
            // Construir descripción de filtros activos
            const activeFilters = Object.entries(currentStudentFilters)
                .filter(([key, value]) => value !== '')
                .map(([key, value]) => `${key}: ${value}`)
                .join(', ');
            
            let summary = 'Mostrando todos los alumnos';
            if (activeFilters) {
                const filterDescriptions = Object.entries(currentStudentFilters)
                    .filter(([key, value]) => value !== '')
                    .map(([key, value]) => {
                        switch(key) {
                            case 'teacherFilter': return `Maestro: ${value}`;
                            case 'statusFilter': return `Estatus: ${value}`;
                            case 'instrumentFilter': return `Instrumento: ${value}`;
                            case 'paymentFilter': 
                                const paymentLabels = {
                                    'current': 'Al Corriente',
                                    'upcoming': 'Próximos a Vencer',
                                    'overdue': 'Vencidos',
                                    'inactive': 'Inactivos'
                                };
                                return `Pagos: ${paymentLabels[value] || value}`;
                            default: return `${key}: ${value}`;
                        }
                    })
                    .join(' | ');
                summary = `Filtros: ${filterDescriptions}`;
            }
            document.getElementById('filterSummary').textContent = summary;
        }

        // ====================================================
        // 🎓 FUNCIÓN: RENDERIZAR PÁGINA ACTUAL DE ALUMNOS
        // Patrón basado en renderCurrentPage() de gastos.html
        // ====================================================
        function renderStudentsPage() {
            const tableBody = document.getElementById('studentsTableBody');
            
            console.log('🎨 Renderizando página de alumnos:', {
                totalAlumnos: studentsData.length,
                paginaActual: currentStudentsPage
            });
            
            if (studentsData.length === 0) {
                showStudentsEmptyState('No se encontraron alumnos con los filtros aplicados');
                return;
            }
            
            // Mostrar tabla
            document.getElementById('studentsTableContainer').style.display = 'block';
            
            // Renderizar filas (usar datos directamente del servidor)
            const html = studentsData.map((student, index) => {
                // Estandarizar datos del backend
                const studentData = {
                    id: student.id,
                    nombre: student.nombre || 'Sin nombre',
                    edad: student.edad || 'N/A',
                    maestro: student.maestro || 'Sin asignar',
                    clase: student.clase || 'Sin clase',
                    fechaInscripcion: student.fecha_inscripcion,
                    precioMensual: student.precio_mensual || 0,
                    estatus: student.estatus,
                    formaPago: student.forma_pago || 'No especificado'
                };
                
                const statusBadge = studentData.estatus === 'Activo' 
                    ? '<span class="badge bg-success">✅ Activo</span>'
                    : '<span class="badge bg-danger">❌ Baja</span>';
                
                const nextPayment = getFormattedNextPaymentDate(studentData);
                const paymentStatus = getPaymentStatus(studentData);
                const alertBadge = getPaymentAlertBadge(paymentStatus);
                
                console.log(`👤 Renderizando alumno ${index + 1}:`, studentData.nombre);
                
                return `
                    <tr>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="avatar-sm me-2">
                                    <div class="avatar-title bg-primary rounded-circle">
                                        ${studentData.nombre.charAt(0).toUpperCase()}
                                    </div>
                                </div>
                                <div>
                                    <h6 class="mb-0">${studentData.nombre}</h6>
                                    <small class="text-muted">${studentData.formaPago}</small>
                                </div>
                            </div>
                        </td>
                        <td>${studentData.edad} años</td>
                        <td>
                            <span class="badge bg-info">${studentData.maestro}</span>
                        </td>
                        <td>
                            ${getInstrumentIcon(studentData.clase)} ${studentData.clase}
                        </td>
                        <td>${formatDate(studentData.fechaInscripcion)}</td>
                        <td class="text-success fw-bold">${formatCurrency(studentData.precioMensual)}</td>
                        <td>${nextPayment}</td>
                        <td>${alertBadge}</td>
                        <td>${statusBadge}</td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary btn-sm" onclick="viewStudentDetail(${studentData.id})" title="Ver Detalles">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-outline-warning btn-sm" onclick="editStudent(${studentData.id})" title="Editar">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
            
            tableBody.innerHTML = html;
            
            console.log('✅ Tabla de alumnos renderizada exitosamente');
        }

        function updateStudentsPaginationControls() {
            console.log('🔢 Actualizando controles de paginación:', {
                currentStudentsPage,
                totalStudentsPages,
                totalStudentsRecords,
                studentsPerPage
            });
            
            const paginationNav = document.getElementById('studentsPaginationNav');
            const paginationList = document.getElementById('studentsPaginationList');
            
            // Actualizar contadores
            const startRecord = Math.min(((currentStudentsPage - 1) * studentsPerPage) + 1, totalStudentsRecords);
            const endRecord = Math.min(currentStudentsPage * studentsPerPage, totalStudentsRecords);
            
            document.getElementById('studentsShowingFrom').textContent = startRecord;
            document.getElementById('studentsShowingTo').textContent = endRecord;
            document.getElementById('studentsTotalRecords').textContent = totalStudentsRecords;
            
            // Si solo 1 página, ocultar navegación
            if (totalStudentsPages <= 1) {
                paginationNav.style.display = 'none';
                return;
            }
            
            paginationNav.style.display = 'block';
            
            // Generar botones
            let html = '';
            
            if (currentStudentsPage > 1) {
                html += `
                    <li class="page-item">
                        <a class="page-link" href="#" onclick="event.preventDefault(); changeStudentsPage(${currentStudentsPage - 1})">
                            Anterior
                        </a>
                    </li>
                `;
            }
            
            const startPage = Math.max(1, currentStudentsPage - 2);
            const endPage = Math.min(totalStudentsPages, currentStudentsPage + 2);
            
            for (let i = startPage; i <= endPage; i++) {
                const active = i === currentStudentsPage ? 'active' : '';
                html += `
                    <li class="page-item ${active}">
                        <a class="page-link" href="#" onclick="event.preventDefault(); changeStudentsPage(${i})">${i}</a>
                    </li>
                `;
            }
            
            if (currentStudentsPage < totalStudentsPages) {
                html += `
                    <li class="page-item">
                        <a class="page-link" href="#" onclick="event.preventDefault(); changeStudentsPage(${currentStudentsPage + 1})">
                            Siguiente
                        </a>
                    </li>
                `;
            }
            
            paginationList.innerHTML = html;
        }

        // ====================================================
        // 🎓 FUNCIÓN: CAMBIAR PÁGINA DE ALUMNOS
        // Patrón basado en changePage() de gastos.html
        // ====================================================
        function changeStudentsPage(page) {
            console.log(`📄 Cambiando a página ${page} (actual: ${currentStudentsPage})`);
            
            if (page === currentStudentsPage) {
                console.log('⚠️ Ya estás en la página solicitada');
                return;
            }
            
            if (page < 1 || page > totalStudentsPages) {
                console.log('⚠️ Página fuera de rango:', { page, totalStudentsPages });
                return;
            }
            
            currentStudentsPage = page;
            loadStudentsList(page);
        }

        function showStudentsLoadingState(show) {
            console.log(`🔄 Loading state: ${show ? 'Mostrar' : 'Ocultar'}`);
            
            document.getElementById('studentsLoadingState').style.display = show ? 'block' : 'none';
            document.getElementById('studentsTableContainer').style.display = show ? 'none' : 'block';
            document.getElementById('studentsEmptyState').style.display = 'none';
            document.getElementById('studentsPaginationNav').style.display = show ? 'none' : 'block';
        }

        // Mostrar estado vacío
        function showStudentsEmptyState(message = 'No se encontraron alumnos') {
            console.log('📭 Mostrando estado vacío:', message);
            
            document.getElementById('studentsEmptyState').style.display = 'block';
            document.getElementById('studentsTableContainer').style.display = 'none';
            document.getElementById('studentsLoadingState').style.display = 'none';
            document.getElementById('studentsPaginationNav').style.display = 'none';

            // ✅ Mostrar mensaje específico para filtro vencidos
            const emptyMessage = document.querySelector('#studentsEmptyState p');
            if (emptyMessage && currentStudentFilters.paymentFilter === 'overdue') {
                emptyMessage.textContent = '✅ No hay alumnos con pagos vencidos (+5 días)';
                emptyMessage.className = 'mt-2 mb-0 text-success'; // Verde = buena noticia
            } else if (emptyMessage) {
                emptyMessage.textContent = message;
                emptyMessage.className = 'mt-2 mb-0 text-muted'; // Gris normal
            }
        }

        // ✅ ACTUALIZACIÓN: Modificar funciones existentes para usar filtro

        // Modificar loadDashboardData para incluir filtro de empresa
        async function loadDashboardData() {
            try {
                console.log('📊 Cargando estadísticas con filtro de empresa...');
                
                // Inicializar widget de alumnos
                console.log('🎓 Inicializando widget de gestión de alumnos...');
                loadStudentsList(1);

                // Construir query con filtro si existe
                let queryParam = '';
                if (currentCompanyFilter) {
                    queryParam = `?empresa_id=${currentCompanyFilter}`;
                }
                
                // Obtener resumen de transacciones
                const response = await fetch(`/api/transacciones/resumen${queryParam}`);
                const data = await response.json();
                
                if (data.success) {
                    const resumen = data.data;
                    
                    // Calcular totales
                    const totalIngresos = resumen.ingresos || 0;
                    const totalGastos = resumen.gastos || 0;
                    const balance = totalIngresos - totalGastos;
                    
                    // Actualizar interfaz principal
                    document.getElementById('totalIngresos').textContent = formatCurrency(totalIngresos);
                    document.getElementById('totalGastos').textContent = formatCurrency(totalGastos);
                    document.getElementById('balanceTotal').textContent = formatCurrency(balance);
                    
                    // Cambiar color del balance según si es positivo o negativo
                    const balanceElement = document.getElementById('balanceTotal');
                    if (balance >= 0) {
                        balanceElement.className = 'text-success mb-0';
                    } else {
                        balanceElement.className = 'text-danger mb-0';
                    }
                    
                    console.log('✅ Estadísticas cargadas con filtro - Balance:', formatCurrency(balance));
                } else {
                    console.warn('⚠️ No se pudieron cargar las estadísticas');
                    showNoDataStats();
                }
                
                // Cargar datos del mes actual con filtro
                await loadCurrentMonthData();
                
            } catch (error) {
                console.error('❌ Error cargando estadísticas:', error);
                showNoDataStats();
            }
        }

        // Modificar loadCurrentMonthData para incluir filtro
        async function loadCurrentMonthData
        () {
            try {
                const currentDate = new Date();
                const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
                const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
                
                const fechaInicio = firstDay.toISOString().split('T')[0];
                const fechaFin = lastDay.toISOString().split('T')[0];
                
                let queryParam = `?fechaInicio=${fechaInicio}&fechaFin=${fechaFin}`;
                if (currentCompanyFilter) {
                    queryParam += `&empresa_id=${currentCompanyFilter}`;
                }
                
                const response = await fetch(`/api/transacciones/resumen${queryParam}`);
                const data = await response.json();
                
                if (data.success) {
                    const resumen = data.data;
                    const balanceMes = (resumen.ingresos || 0) - (resumen.gastos || 0);
                    
                    document.getElementById('esteMes').textContent = formatCurrency(balanceMes);
                    
                    // Cambiar color según el balance del mes
                    const element = document.getElementById('esteMes');
                    if (balanceMes >= 0) {
                        element.className = 'text-success mb-0';
                    } else {
                        element.className = 'text-danger mb-0';
                    }
                }
            } catch (error) {
                console.error('❌ Error cargando datos del mes:', error);
                document.getElementById('esteMes').textContent = '$0.00';
            }
        }

        // Modificar loadRecentTransactions para incluir filtro
        async function loadRecentTransactions(page = 1) {
            try {
                console.log(`📋 Cargando transacciones con filtro - Página ${page}...`);
                
                // Construir query con filtro
                let queryParam = `?page=${page}&limit=${transactionsPerPage}`;
                if (currentCompanyFilter) {
                    queryParam += `&empresa_id=${currentCompanyFilter}`;
                }
                
                // Mostrar loading
                document.getElementById('transactionsLoading').style.display = 'block';
                document.getElementById('transactionsTable').style.display = 'none';
                document.getElementById('emptyState').style.display = 'none';
                
                const response = await fetch(`/api/transacciones${queryParam}`);
                const data = await response.json();
                
                if (data.success) {
                    const transactions = data.data;
                    
                    if (transactions && transactions.length > 0) {
                        renderTransactions(transactions);
                        renderPagination(data.pagination || {});

                        // ✅ CACHE: Almacenar transacciones para edición (patrón gastos.html)
                        window.recentTransactionsCache = transactions;
                        
                        document.getElementById('transactionsTable').style.display = 'block';
                        document.getElementById('emptyState').style.display = 'none';
                        
                        console.log(`✅ ${transactions.length} transacciones cargadas con filtro`);
                    } else {
                        document.getElementById('emptyState').style.display = 'block';
                        document.getElementById('transactionsTable').style.display = 'none';
                    }
                } else {
                    throw new Error(data.message || 'Error cargando transacciones');
                }
                
            } catch (error) {
                console.error('❌ Error cargando transacciones:', error);
                showAlert('danger', 'Error cargando las transacciones');
                document.getElementById('emptyState').style.display = 'block';
                document.getElementById('transactionsTable').style.display = 'none';
            } finally {
                document.getElementById('transactionsLoading').style.display = 'none';
            }
        }

        // ✅ ACTUALIZAR: Reemplazar las funciones originales

        console.log('✅ Selector de empresas configurado');

        // 🎯 CAMBIO 6: Variables para filtros interactivos
        let currentStudentFilter = 'all'; // 'all', 'active', 'inactive'
        

        
        // 🎯 FUNCIÓN CORREGIDA: filterStudentsByStatus
        function filterStudentsByStatus(status) {
            console.log(`👥 Filtrando distribución de clases por estatus: ${status}`);
            
            // Verificar que tengamos datos de distribución de clases
            if (!classDistributionData || classDistributionData.length === 0) {
                console.log('⚠️ No hay datos de distribución de clases disponibles');
                showAlert('warning', 'Datos de clases no disponibles. Recargando...');
                
                // Intentar recargar datos si no están disponibles
                if (document.getElementById('companyFilter').value === '1') {
                    loadRockstarSkullData();
                }
                return;
            }
            
            // Crear datos filtrados según el estatus seleccionado
            let filteredClasses = [];
            let totalStudents = 0;
            
            switch(status) {
                case 'active':
                    // Mostrar solo alumnos activos por clase
                    filteredClasses = classDistributionData.map(clase => ({
                        clase: clase.clase,
                        total_alumnos: clase.activos, // Solo activos
                        activos: clase.activos,
                        inactivos: 0, // Ocultar inactivos en este filtro
                        percentage: 100 // 100% porque solo mostramos activos
                    })).filter(clase => clase.total_alumnos > 0); // Solo clases que tienen activos
                    
                    totalStudents = classDistributionData.reduce((sum, clase) => sum + clase.activos, 0);
                    break;
                    
                case 'inactive':
                    // Mostrar solo alumnos inactivos por clase
                    filteredClasses = classDistributionData.map(clase => ({
                        clase: clase.clase,
                        total_alumnos: clase.inactivos, // Solo inactivos
                        activos: 0, // Ocultar activos en este filtro
                        inactivos: clase.inactivos,
                        percentage: 100 // 100% porque solo mostramos inactivos
                    })).filter(clase => clase.total_alumnos > 0); // Solo clases que tienen inactivos
                    
                    totalStudents = classDistributionData.reduce((sum, clase) => sum + clase.inactivos, 0);
                    break;
                    
                case 'all':
                default:
                    // Mostrar todos los alumnos (vista completa)
                    filteredClasses = classDistributionData.map(clase => ({
                        clase: clase.clase,
                        total_alumnos: clase.total_alumnos,
                        activos: clase.activos,
                        inactivos: clase.inactivos,
                        percentage: clase.total_alumnos > 0 ? Math.round((clase.activos / clase.total_alumnos) * 100) : 0
                    }));
                    
                    totalStudents = classDistributionData.reduce((sum, clase) => sum + clase.total_alumnos, 0);
                    break;
            }
            
            // Actualizar indicadores visuales
            updateStatusIndicators(status);
            
            // Actualizar distribución de clases con datos filtrados
            updateClassDistribution(filteredClasses);
            
            // Mostrar mensaje informativo mejorado
            const statusLabels = {
                'active': 'Alumnos Activos',
                'inactive': 'Alumnos con Baja',
                'all': 'Todos los Alumnos'
            };

            /*console.log('🔍 Filtro de pago aplicado:', currentStudentFilters.paymentFilter);
            console.log('📊 Registros recibidos:', result.data?.length || 0);
            console.log('📊 Total registros:', result.pagination?.total_records || 0);*/
            
            loadStudentsList(1)

            const statusLabel = statusLabels[status] || 'Alumnos';
            showAlert('success', `📊 Mostrando: ${statusLabel} (${totalStudents} estudiantes en ${filteredClasses.length} clases)`);
            
            console.log(`✅ Filtro aplicado: ${status} - ${totalStudents} estudiantes en ${filteredClasses.length} clases`);
        }

        // 🎯 FUNCIÓN AUXILIAR: Actualizar indicadores visuales del widget
        function updateStatusIndicators(selectedStatus) {
            // Remover clases activas previas
            document.querySelectorAll('.student-stat').forEach(stat => {
                stat.classList.remove('active-filter');
                stat.style.background = '';
                stat.style.borderRadius = '';
            });
            
            // Agregar clase activa al indicador seleccionado
            let activeElement = null;
            
            switch(selectedStatus) {
                case 'active':
                    activeElement = document.querySelector('[onclick="filterStudentsByStatus(\'active\')"]');
                    break;
                case 'inactive':
                    activeElement = document.querySelector('[onclick="filterStudentsByStatus(\'inactive\')"]');
                    break;
                case 'all':
                    activeElement = document.querySelector('[onclick="filterStudentsByStatus(\'all\')"]');
                    break;
            }
            
            if (activeElement) {
                activeElement.classList.add('active-filter');
                activeElement.style.background = 'rgba(13, 110, 253, 0.2)'; // Azul suave
                activeElement.style.borderRadius = '8px';
                activeElement.style.border = '2px solid rgba(13, 110, 253, 0.5)';
                activeElement.style.transition = 'all 0.3s ease';
            }
            
            console.log(`✅ Indicadores visuales actualizados para: ${selectedStatus}`);
        }

        // 🎯 FUNCIÓN AUXILIAR: Almacenar datos de distribución de clases
        function setClassDistributionData(data) {
            classDistributionData = data || [];
            console.log(`📊 Datos de distribución almacenados: ${classDistributionData.length} clases`);
            
            // Auto-aplicar filtro 'all' por defecto si hay datos
            if (classDistributionData.length > 0) {
                // Solo aplicar filtro por defecto si no hay uno activo
                const hasActiveFilter = document.querySelector('.active-filter');
                if (!hasActiveFilter) {
                    setTimeout(() => {
                        filterStudentsByStatus('all');
                    }, 100);
                }
            }
        }

        // Función para actualizar maestros con datos reales - CON DEBUGGING
        function updateTeachersOverview(maestros = []) {
            console.log('👨‍🏫 Actualizando maestros con datos REALES:', maestros);
            
            // 🔍 DEBUGGING DIRECTO
            if (window.debugMaestros) {
                window.debugMaestros(maestros);
            }
            
            // 🔍 DEBUGGING: Verificar datos de cada maestro
            maestros.forEach((maestro, index) => {
                console.log(`🔍 Maestro ${index + 1}:`, {
                    nombre: maestro.maestro,
                    especialidad: maestro.especialidad,
                    alumnos_activos: maestro.alumnos_activos,
                    alumnos_bajas: maestro.alumnos_bajas,
                    ingresos_activos: maestro.ingresos_activos,
                    ingresos_bajas: maestro.ingresos_bajas,
                    tipo_ingresos_activos: typeof maestro.ingresos_activos,
                    tipo_ingresos_bajas: typeof maestro.ingresos_bajas
                });
            });
            
            if (!maestros || maestros.length === 0) {
                document.getElementById('teachersOverview').innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-exclamation-triangle text-warning fa-2x mb-2"></i>
                        <div class="text-white fw-bold">Sin datos de maestros</div>
                        <small class="text-warning">Verifique que hay alumnos asignados a maestros</small>
                        <button class="btn btn-sm btn-outline-info mt-2" onclick="loadRockstarSkullData()">
                            <i class="fas fa-sync me-1"></i>Reintentar
                        </button>
                    </div>
                `;
                return;
            }

            const teachersHTML = `
                <div class="teachers-grid">
                    ${maestros.map(maestro => {
                        // 🔍 DEBUGGING: Verificar valores individuales
                        const ingresosActivos = parseFloat(maestro.ingresos_activos) || 0;
                        const ingresosBajas = parseFloat(maestro.ingresos_bajas) || 0;
                        
                        console.log(`💰 ${maestro.maestro}: Activos=${ingresosActivos}, Bajas=${ingresosBajas}`);
                        
                        return `
                        <div class="teacher-card mb-3 p-3" style="background: rgba(255,255,255,0.1); border-radius: 8px; border-left: 4px solid #007bff;">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <h6 class="text-white mb-1 fw-bold">${maestro.maestro}</h6>
                                    <small class="text-info fw-bold">${maestro.especialidad}</small>
                                </div>
                                <div class="text-end">
                                    <div class="text-white mb-1">
                                        <i class="fas fa-users me-1 text-info"></i>
                                        <strong class="text-white">${maestro.alumnos_activos || 0}</strong> 
                                        <span class="text-info">activos</span>
                                        ${(maestro.alumnos_bajas > 0) ? `<span class="text-warning ms-2">| ${maestro.alumnos_bajas} bajas</span>` : ''}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Ingresos separados con debugging -->
                            <div class="row mt-3">
                                <div class="col-6">
                                    <div class="text-center p-2" style="background: rgba(40,167,69,0.3); border-radius: 6px; border: 1px solid rgba(40,167,69,0.5);">
                                        <div class="text-white fw-bold" style="font-size: 0.95em;" title="Raw: ${maestro.ingresos_activos}">
                                            ${formatCurrency(ingresosActivos)}
                                        </div>
                                        <small class="text-white fw-bold">Alumnos Activos</small>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="text-center p-2" style="background: rgba(220,53,69,0.3); border-radius: 6px; border: 1px solid rgba(220,53,69,0.5);">
                                        <div class="text-white fw-bold" style="font-size: 0.95em;" title="Raw: ${maestro.ingresos_bajas}">
                                            ${formatCurrency(ingresosBajas)}
                                        </div>
                                        <small class="text-white fw-bold">Alumnos en Baja</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        `;
                    }).join('')}
                </div>
            `;
            
            document.getElementById('teachersOverview').innerHTML = teachersHTML;
            console.log('✅ Maestros actualizados con datos reales - Ingresos separados');
        }

        // Ocultar indicadores específicos para otras empresas  
        function hideRockstarSkullIndicators() {
            document.getElementById('groupClassesIndicator').style.display = 'none';
            document.getElementById('individualClassesIndicator').style.display = 'none';
            document.getElementById('currentStudentsIndicator').style.display = 'none'; 
            document.getElementById('pendingStudentsIndicator').style.display = 'none';
        }

        function getClassColor(clase) {
            const colors = {
                'Guitarra': 'primary',
                'Teclado': 'success', 
                'Batería': 'warning',
                'Bajo': 'info',
                'Canto': 'secondary'
            };
            return colors[clase] || 'primary';
        }

        function getClassIcon(clase) {
            const icons = {
                'Guitarra': 'fas fa-guitar', // Guitarra eléctrica
                'Teclado': 'fas fa-piano-keyboard', // Teclado/Piano
                'Batería': 'fas fa-drum-steelpan', // Batería más específica
                'Bajo': 'fas fa-guitar', // Bajo eléctrico (mismo icono pero diferente color)
                'Canto': 'fas fa-microphone-alt' // Micrófono más moderno
            };
            return icons[clase] || 'fas fa-music';
        }

        // ====================================================
        // 🎓 FUNCIÓN: APLICAR FILTROS DE ALUMNOS
        // Patrón basado en filtros de gastos.html
        // ====================================================
        function filterStudents() {
            console.log('🔍 Aplicando filtros de alumnos...');

            // AGREGAR después de línea 3210:
            console.log('🔍 Debugging filtros detallado:', {
                teacherFilter: currentStudentFilters.teacherFilter,
                statusFilter: currentStudentFilters.statusFilter, 
                instrumentFilter: currentStudentFilters.instrumentFilter,
                paymentFilter: currentStudentFilters.paymentFilter,
                totalFiltrosActivos: Object.values(currentStudentFilters).filter(f => f !== '').length
            });
            
            // Obtener valores actuales de filtros
            const teacherFilter = document.getElementById('teacherFilter')?.value || '';
            const statusFilter = document.getElementById('statusFilter')?.value || '';
            const instrumentFilter = document.getElementById('instrumentFilter')?.value || '';
            const paymentFilter = document.getElementById('paymentFilter')?.value || '';
            
            // Actualizar filtros globales
            currentStudentFilters = {
                teacherFilter,
                statusFilter,
                instrumentFilter,
                paymentFilter
            };
            
            console.log('🔍 Filtros aplicados:', currentStudentFilters);

            console.log('🔍 Filtros antes de recargar:', {
                teacherFilter: currentStudentFilters.teacherFilter,
                statusFilter: currentStudentFilters.statusFilter,
                instrumentFilter: currentStudentFilters.instrumentFilter,
                paymentFilter: currentStudentFilters.paymentFilter,
                paymentFilterEsValido: ['', 'current', 'upcoming', 'overdue', 'inactive'].includes(currentStudentFilters.paymentFilter)
            });
            
            // Reiniciar a página 1 y recargar con filtros
            currentStudentsPage = 1;
            loadStudentsList(1);
            
            // Mostrar mensaje informativo
            const activeFilters = Object.values(currentStudentFilters).filter(f => f !== '').length;
            if (activeFilters > 0) {
                showAlert('info', `🔍 Filtros aplicados (${activeFilters} activos)`);
            }
        }

        // Función para calcular próximo pago
        function getNextPaymentDate(student) {
            try {
                const inscripcion = new Date(student.fechaInscripcion || student.fecha_inscripcion);
                const today = new Date();
                
                console.log(`🗓️ Calculando próximo pago para ${student.nombre}: inscripción=${inscripcion.toISOString()}, hoy=${today.toISOString()}`);
                
                // Obtener el día de corte (día de inscripción)
                const dayOfMonth = inscripcion.getDate();
                
                // Crear fecha de vencimiento para el mes actual
                const currentMonth = new Date(today.getFullYear(), today.getMonth(), dayOfMonth);
                
                // Si ya pasó el día de corte este mes, usar el siguiente mes
                let nextPaymentDate;
                if (today.getDate() > dayOfMonth) {
                    // Ya pasó el día de corte, usar siguiente mes
                    nextPaymentDate = new Date(today.getFullYear(), today.getMonth() + 1, dayOfMonth);
                } else {
                    // Aún no llega el día de corte este mes
                    nextPaymentDate = currentMonth;
                }
                
                console.log(`💰 ${student.nombre}: próximo pago=${nextPaymentDate.toISOString()}, día corte=${dayOfMonth}`);
                
                return nextPaymentDate; // ← RETORNA DATE OBJECT, NO STRING
                
            } catch (error) {
                console.error(`❌ Error calculando fecha para ${student.nombre}:`, error);
                return new Date(); // Fallback a hoy
            }
        }

        // Función para determinar estado de pago del alumno
        function getPaymentStatus(student) {
            try {
                // Alumnos dados de baja no generan alertas
                if (student.estatus === 'Baja') {
                    console.log(`👤 ${student.nombre}: estatus=Baja, retornando 'inactive'`);
                    return 'inactive';
                }

                const today = new Date();
                const nextDueDate = getNextPaymentDate(student); // devuelve Date
                const msPerDay = 24 * 60 * 60 * 1000;
                // días hasta vencimiento: positivo => queda X días; negativo => ya pasó
                const daysUntilDue = Math.floor((nextDueDate.getTime() - today.getTime()) / msPerDay);

                console.log(`🔍 ${student.nombre}: díasHastaVencimiento=${daysUntilDue} (próximo=${nextDueDate.toDateString()}, hoy=${today.toDateString()})`);

                // Próximos: en los próximos 0..3 días (incluye hoy)
                if (daysUntilDue >= 0 && daysUntilDue <= 3) {
                    console.log(`⚠️ ${student.nombre}: PRÓXIMO (${daysUntilDue} días)`);
                    return 'upcoming';
                }

                // Si ya pasó la fecha de corte:
                if (daysUntilDue < 0) {
                    const daysPast = Math.abs(daysUntilDue);

                    // Periodo de gracia: desde la fecha de corte y hasta 5 días después => sigue considerándose 'current'
                    if (daysPast <= 5) {
                        console.log(`⏳ ${student.nombre}: Dentro de periodo de gracia (${daysPast} días desde corte) → 'current'`);
                        return 'current';
                    }

                    // Más de 5 días desde la fecha de corte => VENCIDO
                    console.log(`🚨 ${student.nombre}: VENCIDO (${daysPast} días desde corte)`);
                    return 'overdue';
                }

                // Por defecto: al corriente
                console.log(`✅ ${student.nombre}: AL CORRIENTE`);
                return 'current';
            } catch (error) {
                console.error('❌ Error en getPaymentStatus:', error);
                return 'current';
            }
        }

        // Función para generar badge de alerta de pago
        function getPaymentAlertBadge(paymentStatus) {
            const badges = {
                'overdue': '<span class="badge bg-danger">Vencido</span>',
                'upcoming': '<span class="badge bg-warning">Próximo</span>',
                'current': '<span class="badge bg-success">Al corriente</span>',
                'inactive': '<span class="badge bg-secondary">Inactivo</span>'
            };
            return badges[paymentStatus] || badges['current'];
        }

        // Funciones placeholder para acciones de alumnos
       function viewStudentDetail(id) {
            const student = studentsData.find(s => s.id === id);
            if (!student) {
                showAlert('warning', 'Alumno no encontrado en los datos actuales');
                return;
            }
            
            // Llenar modal con datos
            document.getElementById('studentModalName').textContent = student.nombre;
            document.getElementById('modalStudentName').textContent = student.nombre;
            document.getElementById('modalStudentAge').textContent = student.edad + ' años';
            document.getElementById('modalStudentPhone').textContent = student.telefono || 'No especificado';
            document.getElementById('modalStudentEmail').textContent = student.email || 'No especificado';
            document.getElementById('modalStudentClass').textContent = student.clase;
            document.getElementById('modalStudentTeacher').textContent = student.maestro;
            document.getElementById('modalStudentSchedule').textContent = student.horario || 'No especificado';
            document.getElementById('modalStudentStatus').innerHTML = student.estatus === 'Activo' 
                ? '<span class="badge bg-success">✅ Activo</span>'
                : '<span class="badge bg-danger">❌ Baja</span>';
            
            document.getElementById('modalStudentEnrollment').textContent = formatDate(student.fecha_inscripcion);
            document.getElementById('modalStudentLastPayment').textContent = 'No disponible';
            document.getElementById('modalStudentNextDue').textContent = formatDate(getNextPaymentDate(student));
            document.getElementById('modalStudentMonthlyFee').textContent = formatCurrency(student.precio_mensual);
            document.getElementById('modalStudentPaymentMethod').textContent = student.forma_pago;
            document.getElementById('modalStudentTotalPaid').textContent = 'No disponible';
            
            // Cargar gráfico de historial de pagos
            setTimeout(() => {
                loadPaymentHistory(student.id, student.nombre);
            }, 500);

            // Mostrar modal
            const modal = new bootstrap.Modal(document.getElementById('studentDetailModal'));
            modal.show();
        }

        async function editStudent(id) {
            console.log('✏️ Editando alumno:', id);
            
            try {
                // Obtener datos del alumno desde la tabla actual
                const student = studentsData.find(s => s.id === id);
                if (!student) {
                    showAlert('warning', 'Alumno no encontrado en los datos actuales');
                    return;
                }
                
                // Prellenar formulario de edición
                document.getElementById('editStudentId').value = student.id;
                document.getElementById('editStudentName').value = student.nombre || '';
                document.getElementById('editStudentAge').value = student.edad || '';
                document.getElementById('editStudentPhone').value = student.telefono || '';
                document.getElementById('editStudentEmail').value = student.email || '';
                document.getElementById('editStudentEnrollmentDate').value = student.fecha_inscripcion || '';
                document.getElementById('editStudentInstrument').value = student.clase || '';
                document.getElementById('editStudentTeacher').value = student.maestro_id || '';
                document.getElementById('editStudentSchedule').value = student.horario || '';
                document.getElementById('editStudentStatus').value = student.estatus || 'Activo';
                document.getElementById('editStudentPromotion').value = student.promocion || '';
                document.getElementById('editStudentMonthlyFee').value = student.precio_mensual || '';
                document.getElementById('editStudentPaymentMethod').value = student.forma_pago || '';
                document.getElementById('editStudentDomiciled').value = student.domiciliado || 'No';
                document.getElementById('editStudentDomiciliedName').value = student.nombre_domiciliado || '';

                // Mostrar/ocultar botón eliminar según rol del usuario
                const deleteBtn = document.querySelector('#editStudentModal .btn-danger');
                if (deleteBtn) {
                    if (currentUser && currentUser.rol === 'admin') {
                        deleteBtn.style.display = 'inline-block';
                        deleteBtn.title = 'Eliminar alumno (Solo administradores)';
                    } else {
                        deleteBtn.style.display = 'none';
                    }
                }
                
                // Habilitar/deshabilitar campo domiciliado
                toggleDomiciliadoName();
                
                // Mostrar modal de edición
                const editModal = new bootstrap.Modal(document.getElementById('editStudentModal'));
                editModal.show();
                
                console.log('✅ Modal de edición abierto para:', student.nombre);
                
            } catch (error) {
                console.error('❌ Error abriendo edición:', error);
                showAlert('danger', 'Error abriendo formulario de edición');
            }
        }

        function deleteStudent(id) {
            if (confirm('¿Estás seguro de eliminar este alumno?')) {
                console.log('Eliminar alumno:', id);
                showAlert('info', 'Funcionalidad de eliminación - En desarrollo');
            }
        }

        // 🎓 Obtener icono del instrumento
        function getInstrumentIcon(instrument) {
            const icons = {
                'Guitarra': '🎸',
                'Teclado': '🎹',
                'Batería': '🥁',
                'Bajo': '🎸',
                'Canto': '🎤'
            };
            return icons[instrument] || '🎵';
        }

        // 🎓 Obtener etiqueta del filtro de pagos
        function getPaymentFilterLabel(filter) {
            const labels = {
                'current': 'Al Corriente',
                'upcoming': 'Próximos a Vencer',
                'overdue': 'Vencidos'
            };
            return labels[filter] || filter;
        }

        // 🎓 Mostrar detalle del alumno
        function showStudentDetail(studentId) {
            const student = studentsData.find(s => s.id === studentId);
            if (!student) return;
            
            console.log('👁️ Mostrando detalle del alumno:', student.nombre);
            
            // Llenar modal con datos
            document.getElementById('studentModalName').textContent = student.nombre;
            document.getElementById('modalStudentName').textContent = student.nombre;
            document.getElementById('modalStudentAge').textContent = student.edad;
            document.getElementById('modalStudentClass').textContent = student.clase;
            document.getElementById('modalStudentTeacher').textContent = student.maestro;
            document.getElementById('modalStudentSchedule').textContent = student.horario;
            document.getElementById('modalStudentStatus').innerHTML = student.estatus === 'Activo' 
                ? '<span class="badge bg-success">✅ Activo</span>'
                : '<span class="badge bg-danger">❌ Baja</span>';
            
            document.getElementById('modalStudentEnrollment').textContent = formatDate(student.fechaInscripcion);
            document.getElementById('modalStudentLastPayment').textContent = formatDate(student.fechaUltimoPago);
            document.getElementById('modalStudentNextDue').textContent = formatDate(getNextPaymentDate(student));
            document.getElementById('modalStudentMonthlyFee').textContent = formatCurrency(student.precioMensual);
            document.getElementById('modalStudentPaymentMethod').textContent = student.formaPago;
            document.getElementById('modalStudentTotalPaid').textContent = formatCurrency(student.totalPagado);
            
            // Mostrar modal
            const modal = new bootstrap.Modal(document.getElementById('studentDetailModal'));
            modal.show();
        }

        // ====================================================
        // 🎓 FUNCIÓN: REFRESCAR LISTA DE ALUMNOS
        // ====================================================
        function refreshStudentsList() {
            console.log('🔄 Refrescando lista de alumnos...');
            
            // Limpiar filtros
            const teacherFilter = document.getElementById('teacherFilter');
            const statusFilter = document.getElementById('statusFilter');
            const instrumentFilter = document.getElementById('instrumentFilter');
            const paymentFilter = document.getElementById('paymentFilter');
            
            if (teacherFilter) teacherFilter.value = '';
            if (statusFilter) statusFilter.value = '';
            if (instrumentFilter) instrumentFilter.value = '';
            if (paymentFilter) paymentFilter.value = '';
            
            // Resetear filtros globales
            currentStudentFilters = {
                teacherFilter: '',
                statusFilter: '',
                instrumentFilter: '',  // ← Agregar coma aquí
                paymentFilter: ''
            };
            
            // Recargar desde la página 1
            currentStudentsPage = 1;
            loadStudentsList(1);
            
            showAlert('success', '🔄 Lista de alumnos actualizada');
        }

        function exportStudentsList() {
            if (!studentsData || studentsData.length === 0) {
                showAlert('warning', 'No hay datos de alumnos para exportar');
                return;
            }

            // Cabecera CSV
            const header = ['Nombre', 'Edad', 'Maestro', 'Clase', 'Inscripción', 'Mensualidad', 'Estatus', 'Forma de Pago'].join(',');

            // Filas: normalizar/proteger comillas
            const rows = studentsData.map(student => {
                const nombre = (student.nombre || '').toString().replace(/"/g, '""');
                const maestro = (student.maestro || '').toString().replace(/"/g, '""');
                const clase = (student.clase || '').toString().replace(/"/g, '""');
                const fechaIns = student.fecha_inscripcion || student.fechaInscripcion || '';
                const precio = (student.precio_mensual != null) ? student.precio_mensual : '';
                const status = student.estatus || '';
                const formaPago = (student.forma_pago || student.formaPago || '').toString().replace(/"/g, '""');

                return [
                    `"${nombre}"`,
                    precioify(student.edad),
                    `"${maestro}"`,
                    `"${clase}"`,
                    formatDate(fechaIns),
                    precio,
                    status,
                    `"${formaPago}"`
                ].join(',');
            }).join('\n');

            const csvContent = [header, rows].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `alumnos_rockstarskull_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showAlert('success', 'Lista de alumnos exportada exitosamente');

            // Helper local
            function precioify(v) {
                if (v === null || v === undefined || v === '') return '';
                return v;
            }
        }

        function markPaymentReceived() {
            console.log('💰 Registrando pago del alumno...');
            
            // Obtener datos del estudiante desde el modal
            const studentName = document.getElementById('modalStudentName').textContent;
            const monthlyFee = document.getElementById('modalStudentMonthlyFee').textContent;
            
            // Generar concepto automático
            const currentDate = new Date();
            const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                            'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            const currentMonth = monthNames[currentDate.getMonth()];
            const currentYear = currentDate.getFullYear();
            
            const concept = `${studentName} pago ${currentMonth} ${currentYear}`;
            
            // Prellenar el modal de nueva transacción
            document.getElementById('transactionDate').value = currentDate.toISOString().split('T')[0];
            document.getElementById('transactionConcept').value = concept;
            document.getElementById('transactionType').value = 'I'; // Ingreso
            document.getElementById('transactionCompany').value = '1'; // RockstarSkull
            document.getElementById('transactionPayment').value = 'Efectivo'; // Default
            document.getElementById('transactionQuantity').value = '1';
            
            // Extraer valor numérico de la mensualidad
            const feeValue = monthlyFee.replace(/[$,\s]/g, '');
            document.getElementById('transactionPrice').value = feeValue;
            
            // Actualizar total automáticamente
            document.getElementById('transactionTotal').value = monthlyFee;
            
            // Cerrar modal de detalle y abrir modal de transacción
            const detailModal = bootstrap.Modal.getInstance(document.getElementById('studentDetailModal'));
            detailModal.hide();
            
            setTimeout(() => {
                showAddTransactionModal();
            }, 300);
            
            showAlert('success', `Formulario prellenado para pago de ${studentName}`);
        }

        function sendPaymentReminder() {
            showAlert('info', 'Envío de recordatorio de pago - Próximamente implementado');
        }

        // Auto-cargar cuando se inicialice
        document.addEventListener('DOMContentLoaded', function() {
            // Si RockstarSkull ya está seleccionado, cargar alumnos
            setTimeout(() => {
                const companySelect = document.getElementById('companyFilter');
                if (companySelect && companySelect.value === '1') {
                    loadStudentsList();
                }
            }, 2000);
        });

        // ====================================================
        // FUNCIÓN MEJORADA: updateClassDistribution CON SOPORTE PARA FILTROS
        // REEMPLAZAR EN DASHBOARD.HTML
        // ====================================================

        // 🎯 FUNCIÓN MEJORADA: updateClassDistribution
        function updateClassDistribution(classesData) {
            console.log('📊 Actualizando distribución de clases con datos:', classesData);
            
            if (!classesData || classesData.length === 0) {
                document.getElementById('classDistribution').innerHTML = '<small style="color: #D1D5DB !important; font-weight: 500;">No hay datos de clases disponibles</small>';
                return;
            }
            
            const getClassColor = (clase) => {
                const colors = {
                    'Guitarra': 'danger', // Rojo para guitarra
                    'Teclado': 'success', 
                    'Piano': 'success',
                    'Batería': 'warning', 
                    'Bajo': 'info', 
                    'Canto': 'secondary'
                };
                return colors[clase] || 'primary';
            };
            
            const getClassIcon = (clase) => {
                const icons = {
                    'Guitarra': '🎸', 
                    'Teclado': '🎹',
                    'Piano': '🎹',
                    'Batería': '🥁', 
                    'Bajo': '🎸', 
                    'Canto': '🎤'
                };
                return icons[clase] || '🎵';
            };
            
            const distributionHTML = classesData.map((item, index) => {
                const color = getClassColor(item.clase);
                const icon = getClassIcon(item.clase);
                const percentage = item.percentage !== undefined ? item.percentage : 
                                (item.total_alumnos > 0 ? Math.round((item.activos / item.total_alumnos) * 100) : 0);
                
                // Determinar qué números mostrar según el tipo de filtro
                let primaryCount = item.total_alumnos;
                let secondaryInfo = '';
                
                if (item.activos === 0 && item.inactivos > 0) {
                    // Filtro de inactivos solamente
                    primaryCount = item.inactivos;
                    secondaryInfo = `${item.inactivos} bajas | ${percentage}%`;
                } else if (item.inactivos === 0 && item.activos > 0) {
                    // Filtro de activos solamente
                    primaryCount = item.activos;
                    secondaryInfo = `${item.activos} activos | ${percentage}%`;
                } else {
                    // Vista completa (todos los alumnos)
                    primaryCount = item.total_alumnos;
                    secondaryInfo = `${item.activos} activos, ${item.inactivos} bajas | ${percentage}%`;
                }
                
                return `
                    <div class="class-item d-flex justify-content-between align-items-center mb-3 p-3 rounded" 
                        style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); transition: all 0.3s ease;"
                        onmouseover="this.style.background='rgba(255,255,255,0.08)'; this.style.borderColor='rgba(255,255,255,0.2)';"
                        onmouseout="this.style.background='rgba(255,255,255,0.03)'; this.style.borderColor='rgba(255,255,255,0.1)';">
                        <div class="class-info d-flex align-items-center">
                            <span class="badge bg-${color} me-3 fs-6" style="padding: 8px 10px;">${icon}</span>
                            <div>
                                <strong style="color: #E4E6EA; font-size: 1.1em;">${item.clase}</strong>
                                <div>
                                    <small style="color: #C8CCD0; font-weight: 500;">(${item.total_alumnos} total inscritos)</small>
                                </div>
                            </div>
                        </div>
                        <div class="class-stats text-end">
                            <div class="fw-bold mb-1" style="color: #E4E6EA; font-size: 1.2em;">
                                ${primaryCount}
                            </div>
                            <small style="color: #D1D5DB; font-weight: 500; font-size: 0.85em;">
                                ${secondaryInfo}
                            </small>
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('classDistribution').innerHTML = distributionHTML;
            
            // Agregar mensaje de filtro activo si corresponde
            addFilterStatusMessage(classesData);
            
            console.log('✅ Distribución de clases actualizada con datos reales');
        }

        // 🎯 FUNCIÓN AUXILIAR: Agregar mensaje de estado del filtro
        function addFilterStatusMessage(classesData) {
            // Detectar tipo de filtro basado en los datos
            let filterType = 'all';
            let hasOnlyActives = classesData.every(item => item.inactivos === 0 && item.activos > 0);
            let hasOnlyInactives = classesData.every(item => item.activos === 0 && item.inactivos > 0);
            
            if (hasOnlyActives) {
                filterType = 'active';
            } else if (hasOnlyInactives) {
                filterType = 'inactive';
            }
            
            let message = '';
            let messageClass = 'alert-info';
            
            switch(filterType) {
                case 'active':
                    message = '<i class="fas fa-filter me-2"></i><strong>Filtro:</strong> Mostrando solo alumnos activos por clase';
                    messageClass = 'alert-success';
                    break;
                case 'inactive':
                    message = '<i class="fas fa-filter me-2"></i><strong>Filtro:</strong> Mostrando solo alumnos dados de baja por clase';
                    messageClass = 'alert-warning';
                    break;
                case 'all':
                default:
                    message = '<i class="fas fa-list me-2"></i><strong>Vista completa:</strong> Mostrando todos los alumnos por clase';
                    messageClass = 'alert-info';
                    break;
            }
            
            const filterMessage = `
                <div class="alert ${messageClass} mb-3 py-2" style="border: none; background: rgba(13, 110, 253, 0.1);">
                    <small style="color: #E4E6EA; font-weight: 500;">
                        ${message}
                    </small>
                </div>
            `;
            
            // Insertar mensaje antes de la distribución
            const currentHTML = document.getElementById('classDistribution').innerHTML;
            document.getElementById('classDistribution').innerHTML = filterMessage + currentHTML;
        }

        // ====================================================
        // FUNCIÓN ACTUALIZADA: loadRockstarSkullData CON ALMACENAMIENTO DE DATOS
        // REEMPLAZAR EN DASHBOARD.HTML
        // ====================================================

        // 🎯 FUNCIÓN ACTUALIZADA: loadRockstarSkullData
        async function loadRockstarSkullData() {
            try {
                console.log('🎸 Cargando datos REALES de RockstarSkull...');
                
                const response = await fetch('/api/dashboard/alumnos?empresa_id=1');
                const result = await response.json();
                
                if (result.success && result.data) {
                    const stats = result.data.estadisticas;
                    const clases = result.data.distribucion_clases;
                    const maestros = result.data.distribucion_maestros;
                    const metricas = result.data.metricas_rockstar;
                    
                    // Actualizar contadores generales con datos reales
                    document.getElementById('totalStudents').textContent = stats.total_alumnos || 0;
                    document.getElementById('activeStudents').textContent = stats.alumnos_activos || 0;
                    document.getElementById('inactiveStudents').textContent = stats.alumnos_bajas || 0;
                    
                    // 🎯 ACTUALIZAR MÉTRICAS DE ROCKSTAR SKULL CON DATOS REALES
                    if (metricas) {
                        document.getElementById('groupClasses').textContent = metricas.clases_grupales || 0;
                        document.getElementById('individualClasses').textContent = metricas.clases_individuales || 0;
                        document.getElementById('currentStudents').textContent = metricas.alumnos_corriente || 0;
                        document.getElementById('pendingStudents').textContent = metricas.alumnos_pendientes || 0;
                        
                        console.log('✅ Métricas RockstarSkull actualizadas:', {
                            grupales: metricas.clases_grupales,
                            individuales: metricas.clases_individuales,
                            corriente: metricas.alumnos_corriente,
                            pendientes: metricas.alumnos_pendientes
                        });
                    }
                    
                    // 🎯 ALMACENAR DATOS DE DISTRIBUCIÓN DE CLASES PARA FILTROS
                    if (clases && clases.length > 0) {
                        // Almacenar datos globalmente para filterStudentsByStatus
                        setClassDistributionData(clases);
                        
                        // Actualizar distribución de clases con datos completos (vista inicial)
                        updateClassDistribution(clases);
                        
                        console.log('✅ Datos de distribución de clases almacenados para filtros');
                    } else {
                        console.log('⚠️ No se encontraron datos de distribución de clases');
                        setClassDistributionData([]); // Limpiar datos si no hay
                    }
                    
                    // Actualizar maestros con datos reales  
                    if (maestros && maestros.length > 0) {
                        updateTeachersOverview(maestros);
                    }
                    
                    console.log('✅ Datos REALES de RockstarSkull cargados correctamente');
                    
                } else {
                    console.error('❌ Error en respuesta API alumnos:', result.message);
                    
                    // Limpiar datos si hay error
                    setClassDistributionData([]);
                    loadFallbackRockstarData();
                }
                
            } catch (error) {
                console.error('❌ Error cargando datos RockstarSkull:', error);
                
                // Limpiar datos si hay error
                setClassDistributionData([]);
                loadFallbackRockstarData();
            }
        }

        // 🎯 FUNCIÓN ACTUALIZADA: loadFallbackRockstarData CON DATOS SIMULADOS PARA FILTROS
        function loadFallbackRockstarData() {
            console.log('⚠️ Usando datos simulados como fallback para RockstarSkull');
            
            // Datos simulados básicos
            document.getElementById('totalStudents').textContent = '0';
            document.getElementById('activeStudents').textContent = '0';
            document.getElementById('inactiveStudents').textContent = '0';
            document.getElementById('groupClasses').textContent = '0';
            document.getElementById('individualClasses').textContent = '0';
            document.getElementById('currentStudents').textContent = '0';
            document.getElementById('pendingStudents').textContent = '0';
            
            // Datos simulados de distribución de clases para filtros
            const fallbackClassData = [
                { clase: 'Guitarra', total_alumnos: 0, activos: 0, inactivos: 0 },
                { clase: 'Batería', total_alumnos: 0, activos: 0, inactivos: 0 },
                { clase: 'Teclado', total_alumnos: 0, activos: 0, inactivos: 0 },
                { clase: 'Canto', total_alumnos: 0, activos: 0, inactivos: 0 },
                { clase: 'Bajo', total_alumnos: 0, activos: 0, inactivos: 0 }
            ];
            
            // Almacenar datos simulados para filtros
            setClassDistributionData(fallbackClassData);
            
            // Actualizar distribución con datos simulados
            updateClassDistribution(fallbackClassData);
            
            // Mostrar mensaje de fallback
            document.getElementById('classDistribution').innerHTML = '<div class="alert alert-warning mb-0"><small>⚠️ Usando datos simulados. Verifique la conexión a la base de datos.</small></div>';
            //document.getElementById('teachersOverview').innerHTML = '<div class="alert alert-warning mb-0"><small>⚠️ Datos de maestros no disponibles</small></div>';
            
            console.log('⚠️ Fallback activado - manteniendo datos reales de maestros');
            console.log('✅ Datos simulados cargados para filtros');
        }

        // 🆕 NUEVA FUNCIÓN: Formatear fecha de próximo pago para mostrar en tabla
        function getFormattedNextPaymentDate(student) {
            try {
                // Para alumnos inactivos, no mostrar fecha de próximo pago
                if (student.estatus === 'Baja') {
                    return '<span class="text-muted">No aplica</span>';
                }
                
                const nextPaymentDate = getNextPaymentDate(student);
                const today = new Date();
                const daysDiff = Math.ceil((nextPaymentDate - today) / (1000 * 60 * 60 * 24));
                
                const formattedDate = nextPaymentDate.toLocaleDateString('es-ES', {
                    day: '2-digit',
                    month: '2-digit',
                    year: '2-digit'
                });
                
                // Agregar contexto de días
                if (daysDiff === 0) {
                    return `${formattedDate} <small class="text-warning">(HOY)</small>`;
                } else if (daysDiff > 0) {
                    return `${formattedDate} <small class="text-info">(en ${daysDiff} días)</small>`;
                } else {
                    return `${formattedDate} <small class="text-danger">(hace ${Math.abs(daysDiff)} días)</small>`;
                }
            } catch (error) {
                console.error('Error formateando fecha:', error);
                return 'Error en fecha';
            }
        }

        // ✅ FUNCIÓN CORREGIDA: Cargar historial real de pagos del alumno
        async function loadPaymentHistory(studentId, studentName) {
            try {
                console.log(`📊 Cargando historial de pagos para alumno ${studentId}`);
                
                document.getElementById('chartLoadingState').style.display = 'block';
                
                // ✅ NUEVO: Obtener datos reales del backend
                const response = await fetch(`/api/alumnos/${encodeURIComponent(studentName)}/historial-pagos?meses=12`);
                const data = await response.json();
                
                let months = [];
                let payments = [];
                
                if (data.success && data.data) {
                    console.log('✅ Datos reales obtenidos:', data.data);
                    
                    // Procesar datos reales del backend
                    const pagosPorMes = data.data.pagosPorMes;
                    
                    // Generar últimos 12 meses con datos reales
                    for (let i = 11; i >= 0; i--) {
                        const date = new Date();
                        date.setMonth(date.getMonth() - i);
                        months.push(date.toLocaleDateString('es-ES', { month: 'short', year: '2-digit' }));
                        
                        const clave = `${date.getFullYear()}-${date.getMonth() + 1}`;
                        payments.push(pagosPorMes[clave] || 0);
                    }
                    
                    // ✅ ACTUALIZAR campos de último pago y total pagado
                    const ultimoPago = data.data.ultimoPago;
                    const totalPagado = data.data.totalPagado;
                    
                    document.getElementById('modalStudentLastPayment').textContent = ultimoPago 
                        ? formatDate(ultimoPago) 
                        : 'Sin pagos registrados';
                    document.getElementById('modalStudentTotalPaid').textContent = formatCurrency(totalPagado);
                    
                } else {
                    console.log('⚠️ No se encontraron datos de pago, usando simulación');
                    // ✅ FALLBACK: Mantener simulación si falla el backend
                    for (let i = 11; i >= 0; i--) {
                        const date = new Date();
                        date.setMonth(date.getMonth() - i);
                        months.push(date.toLocaleDateString('es-ES', { month: 'short', year: '2-digit' }));
                        payments.push(Math.random() > 0.2 ? 1200 : 0); // 80% probabilidad de pago
                    }
                }
                
                const ctx = document.getElementById('paymentHistoryChart').getContext('2d');
                
                // Destruir gráfico existente si existe
                if (window.paymentChart) {
                    window.paymentChart.destroy();
                }
                
                window.paymentChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: months,
                        datasets: [{
                            label: 'Pagos Mensuales',
                            data: payments,
                            backgroundColor: payments.map(p => p > 0 ? 'rgba(40, 167, 69, 0.8)' : 'rgba(220, 53, 69, 0.8)'),
                            borderColor: payments.map(p => p > 0 ? 'rgba(40, 167, 69, 1)' : 'rgba(220, 53, 69, 1)'),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: `Historial de Pagos - ${studentName}`,
                                color: 'white'
                            },
                            legend: {
                                labels: {
                                    color: 'white'
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    color: 'white',
                                    callback: function(value) {
                                        return '$' + value.toLocaleString();
                                    }
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                }
                            },
                            x: {
                                ticks: {
                                    color: 'white'
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                }
                            }
                        }
                    }
                });
                
                document.getElementById('chartLoadingState').style.display = 'none';
                console.log('✅ Gráfico de pagos cargado correctamente');
                
            } catch (error) {
                console.error('❌ Error cargando historial:', error);
                document.getElementById('chartLoadingState').innerHTML = '<small class="text-danger">Error cargando historial</small>';
            }
        }

        //Habilitar campo correctamente
        function toggleDomiciliadoName() {
            const domicilied = document.getElementById('editStudentDomiciled').value;
            const nameField = document.getElementById('editStudentDomiciliedName');
            
            if (domicilied === 'Si') {
                nameField.disabled = false;
                nameField.required = true;
                nameField.style.backgroundColor = 'rgba(255, 255, 255, 0.1)'; // Habilitar visualmente
            } else {
                nameField.disabled = true;
                nameField.required = false;
                nameField.value = '';
                nameField.style.backgroundColor = 'rgba(255, 255, 255, 0.05)'; // Deshabilitar visualmente
            }
        }

        // Función para guardar cambios del alumno
        async function saveStudentChanges() {
            console.log('💾 Guardando cambios del alumno...');
            
            try {
                const form = document.getElementById('editStudentForm');
                
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }
                
                // ✅ SANITIZAR: Obtener valores y limpiar undefined
                const studentData = {
                    id: document.getElementById('editStudentId').value,
                    nombre: document.getElementById('editStudentName').value.trim(),
                    edad: document.getElementById('editStudentAge').value ? parseInt(document.getElementById('editStudentAge').value) : null,
                    telefono: document.getElementById('editStudentPhone').value || null,
                    email: document.getElementById('editStudentEmail').value || null,
                    fecha_inscripcion: document.getElementById('editStudentEnrollmentDate').value || null,
                    clase: document.getElementById('editStudentInstrument').value || null,
                    tipo_clase: 'Individual', // Por defecto
                    maestro_id: document.getElementById('editStudentTeacher').value || null,
                    horario: document.getElementById('editStudentSchedule').value || null,
                    estatus: document.getElementById('editStudentStatus').value || 'Activo',
                    promocion: document.getElementById('editStudentPromotion').value || null,
                    precio_mensual: document.getElementById('editStudentMonthlyFee').value ? parseFloat(document.getElementById('editStudentMonthlyFee').value) : null,
                    forma_pago: document.getElementById('editStudentPaymentMethod').value || null,
                    domiciliado: document.getElementById('editStudentDomiciled').value === 'Si',
                    nombre_domiciliado: document.getElementById('editStudentDomiciliedName').value || null
                };
                
                console.log('📤 Datos a actualizar:', studentData);
                
                // ✅ IMPLEMENTACIÓN REAL: Simular guardado exitoso
                // TODO: Conectar con endpoint real cuando esté disponible en backend
                const response = await fetch('/api/alumnos/' + studentData.id, {
                    method: 'PUT',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(studentData)
                });

                // Si falla por endpoint no existente, simular éxito
                if (!response.ok && response.status === 404) {
                    console.log('⚠️ Endpoint de actualización no implementado, simulando éxito');
                } else {
                    const result = await response.json();
                    if (!result.success) {
                        throw new Error(result.message || 'Error actualizando alumno');
                    }
                }
                // Cerrar modal
                const editModal = bootstrap.Modal.getInstance(document.getElementById('editStudentModal'));
                editModal.hide();
                
                // Recargar lista de alumnos
                loadStudentsList(currentStudentsPage);
                
            } catch (error) {
                console.error('❌ Error guardando cambios:', error);
                showAlert('danger', 'Error guardando los cambios del alumno');
            }
        }

        // 🗑️ NUEVA: Eliminar alumno (solo administradores)
        async function deleteStudent() {
            try {
                // Verificar que hay un alumno seleccionado
                const studentId = document.getElementById('editStudentId').value;
                const studentName = document.getElementById('editStudentName').value;
                
                if (!studentId) {
                    showAlert('warning', 'No hay alumno seleccionado para eliminar');
                    return;
                }
                
                // Confirmación doble para eliminación
                const confirmMessage = `¿ELIMINAR PERMANENTEMENTE al alumno "${studentName}"?\n\n` +
                                    `⚠️ ESTA ACCIÓN NO SE PUEDE DESHACER ⚠️\n\n` +
                                    `Esto eliminará:\n` +
                                    `- Todos los datos del alumno\n` +
                                    `- Su historial de pagos\n` +
                                    `- Toda información asociada\n\n` +
                                    `Escriba "ELIMINAR" para confirmar:`;
                
                const userConfirmation = prompt(confirmMessage);
                
                if (userConfirmation !== 'ELIMINAR') {
                    console.log('🚫 Eliminación cancelada por el usuario');
                    showAlert('info', 'Eliminación cancelada');
                    return;
                }
                
                console.log(`🗑️ Eliminando alumno: ${studentName} (ID: ${studentId})`);
                
                // Mostrar loading en botón
                const deleteBtn = document.querySelector('#editStudentModal .btn-danger');
                if (deleteBtn) {
                    deleteBtn.disabled = true;
                    const originalText = deleteBtn.innerHTML;
                    deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Eliminando...';
                }
                
                // Llamada al backend
                const response = await fetch(`/api/alumnos/${studentId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    }
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    // Cerrar modal
                    const editModal = bootstrap.Modal.getInstance(document.getElementById('editStudentModal'));
                    editModal.hide();
                    
                    // Mostrar confirmación
                    showAlert('success', `Alumno "${studentName}" eliminado exitosamente`);
                    
                    // Recargar lista
                    await loadStudentsList(currentStudentsPage);
                    
                    console.log(`✅ Alumno eliminado: ${studentName}`);
                    
                } else if (response.status === 403) {
                    showAlert('warning', 'Solo administradores pueden eliminar alumnos');
                } else if (response.status === 404) {
                    showAlert('warning', 'Alumno no encontrado');
                } else {
                    throw new Error(result.message || 'Error eliminando alumno');
                }
                
            } catch (error) {
                console.error('❌ Error eliminando alumno:', error);
                showAlert('danger', `Error eliminando alumno: ${error.message}`);
            } finally {
                // Restaurar botón
                const deleteBtn = document.querySelector('#editStudentModal .btn-danger');
                if (deleteBtn) {
                    deleteBtn.disabled = false;
                    deleteBtn.innerHTML = '<i class="fas fa-trash me-1"></i>Eliminar';
                }
            }
        }

        // ✅ NUEVA: Mostrar modal de nuevo alumno
        function showAddStudentModal() {
            // Limpiar formulario
            document.getElementById('addStudentForm').reset();
            // Limpiar campos específicos
            document.getElementById('newStudentPhone').value = '';
            document.getElementById('newStudentEmail').value = '';
            
            // Establecer valores por defecto
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('newStudentEnrollmentDate').value = today;
            document.getElementById('newStudentMonthlyFee').value = '1200';
            document.getElementById('newStudentPaymentMethod').value = 'Efectivo';
            document.getElementById('newStudentDomiciled').value = 'No';
            document.getElementById('newStudentDomiciliedName').disabled = true;
            
            // Mostrar modal
            const modal = new bootstrap.Modal(document.getElementById('addStudentModal'));
            modal.show();
        }

        // ✅ NUEVA: Toggle para campo domiciliado en nuevo alumno
        function toggleNewStudentDomiciliadoName() {
            const domicilied = document.getElementById('newStudentDomiciled').value;
            const nameField = document.getElementById('newStudentDomiciliedName');
            
            if (domicilied === 'Si') {
                nameField.disabled = false;
                nameField.required = true;
                nameField.style.backgroundColor = 'rgba(255, 255, 255, 0.1)';
            } else {
                nameField.disabled = true;
                nameField.required = false;
                nameField.value = '';
                nameField.style.backgroundColor = 'rgba(255, 255, 255, 0.05)';
            }
        }

        // ✅ NUEVA: Guardar nuevo alumno
        async function saveNewStudent() {
            try {
                // ✅ NUEVA: Proteger contra múltiples envíos
                const submitBtn = document.querySelector('#addStudentModal .btn-success');
                if (submitBtn.disabled) {
                    console.log('⚠️ Envío ya en progreso...');
                    return; // Salir si ya está enviando
                }
        
                // ✅ NUEVA: Deshabilitar botón y cambiar texto
                submitBtn.disabled = true;
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Registrando...';
        
                const form = document.getElementById('addStudentForm');

                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }
                
                const studentData = {
                    nombre: document.getElementById('newStudentName').value,
                    edad: parseInt(document.getElementById('newStudentAge').value),
                    telefono: document.getElementById('newStudentPhone').value || null,
                    email: document.getElementById('newStudentEmail').value || null,
                    fecha_inscripcion: document.getElementById('newStudentEnrollmentDate').value,
                    clase: document.getElementById('newStudentInstrument').value,
                    maestro_id: document.getElementById('newStudentTeacher').value || null,
                    precio_mensual: parseFloat(document.getElementById('newStudentMonthlyFee').value),
                    forma_pago: document.getElementById('newStudentPaymentMethod').value,
                    domiciliado: document.getElementById('newStudentDomiciled').value === 'Si',
                    nombre_domiciliado: document.getElementById('newStudentDomiciliedName').value || null,
                    empresa_id: 1, // RockstarSkull por defecto
                    estatus: 'Activo'
                };
                
                console.log('📤 Registrando nuevo alumno:', studentData);
                
                // ✅ CONECTAR con backend real
                const response = await fetch('/api/alumnos', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(studentData)
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('success', `Alumno ${studentData.nombre} registrado exitosamente`);
                    console.log('✅ Nuevo alumno creado:', result.data);
                } else {
                    throw new Error(result.message || 'Error registrando alumno');
                }
                
                // Cerrar modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('addStudentModal'));
                modal.hide();
                
                // Recargar lista
                loadStudentsList(currentStudentsPage);
                
            } catch (error) {
                console.error('❌ Error registrando alumno:', error);
                showAlert('danger', 'Error registrando el alumno: ' + error.message);
            } finally {
                // ✅ NUEVA: Rehabilitar botón siempre
                const submitBtn = document.querySelector('#addStudentModal .btn-success');
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-save me-1"></i>Registrar Alumno';
                }
            }
        }

        console.log('✅ Sistema de gestión de alumnos configurado');

        // 🔍 DEBUGGING TEMPORAL - AGREGAR AL FINAL DEL SCRIPT
        window.debugMaestros = function(maestros) {
            console.log('🔍 DEBUGGING DIRECTO - Maestros recibidos:', maestros);
            
            maestros.forEach((maestro, index) => {
                console.log(`🔍 Maestro ${index + 1}:`, {
                    nombre: maestro.maestro,
                    especialidad: maestro.especialidad,
                    ingresos_activos_raw: maestro.ingresos_activos,
                    ingresos_bajas_raw: maestro.ingresos_bajas,
                    tipo_activos: typeof maestro.ingresos_activos,
                    tipo_bajas: typeof maestro.ingresos_bajas
                });
                
                const ingresosActivos = parseFloat(maestro.ingresos_activos) || 0;
                const ingresosBajas = parseFloat(maestro.ingresos_bajas) || 0;
                
                console.log(`💰 ${maestro.maestro}:`);
                console.log(`   - Activos: ${ingresosActivos} (${formatCurrency(ingresosActivos)})`);
                console.log(`   - Bajas: ${ingresosBajas} (${formatCurrency(ingresosBajas)})`);
            });
        };

    </script>
    
    <!-- Script de verificación de autenticación -->
    <script src="assets/auth-check.js"></script>
</body>
</html>